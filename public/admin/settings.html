<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin — Settings</title>
<link rel="icon" type="image/svg+xml" href="/assets/icon.svg">
<link rel="stylesheet" href="/admin/css/admin.css">
</head>
<body>
<div class="app">
  <button id="hamburger" class="hamburger">
    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
  </button>
  <div id="overlay" class="overlay"></div>
  <aside id="sidebar" class="sidebar"></aside>

  <main class="main">
    <h1 class="page-title">Settings</h1>

    <div id="settingsContainer">
      <div class="spinner"></div>
    </div>

    <!-- Email (SMTP) section -->
    <div class="card" style="padding:24px;margin-top:24px">
      <h3 class="settings-section-title">Email (SMTP)</h3>
      <p style="color:var(--text-dim);font-size:.85rem;margin-bottom:16px">
        Configure SMTP for password reset emails and notifications.
      </p>
      <div class="settings-field">
        <label>SMTP Host</label>
        <input type="text" id="smtpHost" placeholder="e.g. smtp.gmail.com" style="margin-bottom:0">
      </div>
      <div style="display:flex;gap:16px;margin-top:12px">
        <div class="settings-field" style="flex:1">
          <label>Port</label>
          <select id="smtpPort" style="margin-bottom:0">
            <option value="587">587 (STARTTLS)</option>
            <option value="465">465 (SSL)</option>
            <option value="25">25 (Plain)</option>
          </select>
        </div>
        <div class="settings-field" style="flex:1">
          <label>Encryption</label>
          <select id="smtpEncryption" style="margin-bottom:0">
            <option value="tls">STARTTLS</option>
            <option value="ssl">SSL/TLS</option>
            <option value="none">None</option>
          </select>
        </div>
      </div>
      <div style="display:flex;gap:16px;margin-top:12px">
        <div class="settings-field" style="flex:1">
          <label>Username</label>
          <input type="text" id="smtpUsername" placeholder="SMTP login" style="margin-bottom:0" autocomplete="off">
        </div>
        <div class="settings-field" style="flex:1">
          <label>Password</label>
          <input type="password" id="smtpPassword" placeholder="SMTP password" style="margin-bottom:0" autocomplete="off">
        </div>
      </div>
      <div style="display:flex;gap:16px;margin-top:12px">
        <div class="settings-field" style="flex:1">
          <label>From Address</label>
          <input type="email" id="smtpFromAddress" placeholder="noreply@example.com" style="margin-bottom:0">
        </div>
        <div class="settings-field" style="flex:1">
          <label>From Name</label>
          <input type="text" id="smtpFromName" placeholder="iRadio" style="margin-bottom:0">
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:16px">
        <button class="btn btn-primary btn-sm" onclick="iRadioSettings.saveSmtp()">Save SMTP Settings</button>
        <button class="btn btn-ghost btn-sm" onclick="iRadioSettings.sendTestEmail()">Send Test Email</button>
      </div>
      <div id="smtpTestStatus" style="margin-top:8px;font-size:.8rem;color:var(--text-dim)"></div>
    </div>

    <!-- Tools section -->
    <div class="card" style="padding:24px;margin-top:24px">
      <h3 class="settings-section-title">Scan and Tag</h3>
      <p style="color:var(--text-dim);font-size:.85rem;margin-bottom:16px">
        Scan all songs and look up metadata (genre) from MusicBrainz.
        Fixes missing titles from filenames. Songs without a match keep their current values.
      </p>
      <div class="settings-field" style="margin-bottom:16px">
        <label>Auto-tag new songs</label>
        <div style="display:flex;align-items:center;gap:12px">
          <label class="toggle">
            <input type="checkbox" id="autoTagEnabled">
            <span class="slider"></span>
          </label>
          <span style="color:var(--text-dim);font-size:.8rem">Automatically tag unprocessed songs every 15 minutes</span>
        </div>
        <div id="autoTagStatus" style="margin-top:8px;font-size:.8rem;color:var(--text-dim)"></div>
      </div>
      <div class="settings-field">
        <label>AcoustID API key <span style="color:var(--text-dim);font-weight:400">(optional — enables audio fingerprinting)</span></label>
        <div style="display:flex;gap:8px;align-items:flex-start">
          <input type="text" id="acoustidApiKey" placeholder="Get a free key at acoustid.org" style="margin-bottom:0;flex:1">
          <button id="btnSaveApiKey" class="btn btn-ghost btn-sm" style="white-space:nowrap" onclick="iRadioSettings.saveApiKey()">Save Key</button>
        </div>
      </div>
      <div id="genreScanStatus" style="display:none;margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;font-size:.85rem;margin-bottom:4px">
          <span id="genreScanLabel">Scanning…</span>
          <span id="genreScanPct">0%</span>
        </div>
        <div style="background:var(--bg-input);border-radius:4px;height:8px;overflow:hidden">
          <div id="genreScanBar" style="background:var(--accent);height:100%;width:0;transition:width .3s"></div>
        </div>
        <div style="font-size:.8rem;color:var(--text-dim);margin-top:6px">
          <span id="genreScanDetails"></span>
        </div>
      </div>
      <button id="btnGenreScan" class="btn btn-primary btn-sm" onclick="iRadioSettings.startGenreScan()">Scan and Tag</button>
      <button id="btnStopScan" class="btn btn-sm hidden" style="background:var(--danger);color:#fff;margin-left:8px" onclick="iRadioSettings.stopGenreScan()">Stop</button>
    </div>

    <!-- Library Sync section -->
    <div class="card" style="padding:24px;margin-top:24px">
      <h3 class="settings-section-title">Library Sync</h3>
      <p style="color:var(--text-dim);font-size:.85rem;margin-bottom:16px">
        Scan all active songs and check that their files still exist on disk.
        Missing files are deactivated (not deleted) so Liquidsoap won't try to play them.
      </p>
      <div id="librarySyncStatus" style="display:none;margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;font-size:.85rem;margin-bottom:4px">
          <span id="librarySyncLabel">Syncing…</span>
          <span id="librarySyncPct">0%</span>
        </div>
        <div style="background:var(--bg-input);border-radius:4px;height:8px;overflow:hidden">
          <div id="librarySyncBar" style="background:var(--accent);height:100%;width:0;transition:width .3s"></div>
        </div>
        <div style="font-size:.8rem;color:var(--text-dim);margin-top:6px">
          <span id="librarySyncDetails"></span>
        </div>
      </div>
      <button id="btnLibrarySync" class="btn btn-primary btn-sm" onclick="iRadioSettings.startLibrarySync()">Sync Library</button>
      <button id="btnStopSync" class="btn btn-sm hidden" style="background:var(--danger);color:#fff;margin-left:8px" onclick="iRadioSettings.stopLibrarySync()">Stop</button>
    </div>

    <!-- Artist Cleanup section -->
    <div class="card" style="padding:24px;margin-top:24px">
      <h3 class="settings-section-title">Artist Cleanup</h3>
      <p style="color:var(--text-dim);font-size:.85rem;margin-bottom:16px">
        Merge duplicate artists created from collaboration tags (feat., &amp;, with).
        Takes the primary artist and reassigns songs. Duo names like "Brooks &amp; Dunn" are preserved.
      </p>
      <div id="artistDedupStatus" style="display:none;margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;font-size:.85rem;margin-bottom:4px">
          <span id="artistDedupLabel">Deduplicating…</span>
          <span id="artistDedupPct">0%</span>
        </div>
        <div style="background:var(--bg-input);border-radius:4px;height:8px;overflow:hidden">
          <div id="artistDedupBar" style="background:var(--accent);height:100%;width:0;transition:width .3s"></div>
        </div>
        <div style="font-size:.8rem;color:var(--text-dim);margin-top:6px">
          <span id="artistDedupDetails"></span>
        </div>
      </div>
      <button id="btnArtistDedup" class="btn btn-primary btn-sm" onclick="iRadioSettings.startArtistDedup()">Deduplicate Artists</button>
      <button id="btnStopDedup" class="btn btn-sm hidden" style="background:var(--danger);color:#fff;margin-left:8px" onclick="iRadioSettings.stopArtistDedup()">Stop</button>
    </div>

    <!-- Audio Normalization section -->
    <div class="card" style="padding:24px;margin-top:24px">
      <h3 class="settings-section-title">Audio Normalization</h3>
      <p style="color:var(--text-dim);font-size:.85rem;margin-bottom:16px">
        Analyze loudness (LUFS) of all songs and calculate per-track gain for consistent volume.
        Gain is applied in real-time during playback — no files are modified.
      </p>
      <div class="settings-field" style="margin-bottom:16px">
        <label>Auto-normalize new songs</label>
        <div style="display:flex;align-items:center;gap:12px">
          <label class="toggle">
            <input type="checkbox" id="autoNormEnabled">
            <span class="slider"></span>
          </label>
          <span style="color:var(--text-dim);font-size:.8rem">Automatically normalize unanalyzed songs every 15 minutes</span>
        </div>
        <div id="autoNormStatus" style="margin-top:8px;font-size:.8rem;color:var(--text-dim)"></div>
      </div>
      <div class="settings-field" style="margin-bottom:16px">
        <label>Target loudness (LUFS)</label>
        <select id="normTargetLufs" style="margin-bottom:0;max-width:260px">
          <option value="-23.0">-23.0 LUFS (broadcast standard)</option>
          <option value="-16.0">-16.0 LUFS (streaming)</option>
          <option value="-14.0">-14.0 LUFS (default)</option>
          <option value="-11.0">-11.0 LUFS (loud / club)</option>
        </select>
      </div>
      <div id="normStatus" style="display:none;margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;font-size:.85rem;margin-bottom:4px">
          <span id="normLabel">Analyzing…</span>
          <span id="normPct">0%</span>
        </div>
        <div style="background:var(--bg-input);border-radius:4px;height:8px;overflow:hidden">
          <div id="normBar" style="background:var(--accent);height:100%;width:0;transition:width .3s"></div>
        </div>
        <div style="font-size:.8rem;color:var(--text-dim);margin-top:6px">
          <span id="normDetails"></span>
        </div>
      </div>
      <button id="btnNormalize" class="btn btn-primary btn-sm" onclick="iRadioSettings.startNormalize()">Normalize</button>
      <button id="btnStopNorm" class="btn btn-sm hidden" style="background:var(--danger);color:#fff;margin-left:8px" onclick="iRadioSettings.stopNormalize()">Stop</button>
    </div>

    <!-- Content Filter section -->
    <div class="card" style="padding:24px;margin-top:24px">
      <h3 class="settings-section-title">Content Filter</h3>
      <p style="color:var(--text-dim);font-size:.85rem;margin-bottom:16px">
        The profanity filter toggle is in the Requests section above.
        A built-in list of common English and Filipino offensive words is always active when the filter is enabled.
        Add your own station-specific blocked words below.
      </p>
      <div class="settings-field">
        <label>Custom blocked words <span style="color:var(--text-dim);font-weight:400">(comma-separated)</span></label>
        <textarea id="blockedWords" rows="3" placeholder="e.g. spam, promo, inappropriate-term" style="margin-bottom:0;width:100%;resize:vertical;font-family:inherit;font-size:.9rem"></textarea>
      </div>
      <button id="btnSaveBlockedWords" class="btn btn-primary btn-sm" style="margin-top:12px" onclick="iRadioSettings.saveBlockedWords()">Save Blocked Words</button>
    </div>

    <!-- Sticky save bar -->
    <div id="saveBar" class="save-bar hidden">
      <span>You have unsaved changes</span>
      <div style="display:flex;gap:8px">
        <button class="btn btn-ghost btn-sm" onclick="iRadioSettings.cancelChanges()">Cancel</button>
        <button id="btnSaveAll" class="btn btn-primary btn-sm" onclick="iRadioSettings.saveAll()">Save Changes</button>
      </div>
    </div>
  </main>
</div>

<div class="toast-container" id="toasts"></div>

<script src="/assets/scroll-controls.js"></script>
<script src="/admin/js/api.js"></script>
<script src="/admin/js/auth.js"></script>
<script src="/admin/js/nav.js"></script>
<script src="/admin/js/settings.js"></script>
<script>
  if (iRadioAuth.requireRole('super_admin')) {
    iRadioNav.init();
    iRadioSettings.init();
  }
</script>
</body>
</html>
