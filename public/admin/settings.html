<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin — Settings</title>
<link rel="icon" type="image/svg+xml" href="/assets/icon.svg">
<link rel="stylesheet" href="/admin/css/admin.css?v=glow1">
</head>
<body>
<div class="app">
  <button id="hamburger" class="hamburger">
    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
  </button>
  <div id="overlay" class="overlay"></div>
  <aside id="sidebar" class="sidebar"></aside>

  <main class="main">
    <h1 class="page-title">Settings</h1>

    <div class="tabs" id="settingsTabs">
      <button class="tab active" data-tab="general">General</button>
      <button class="tab" data-tab="appearance">Appearance</button>
      <button class="tab" data-tab="tools">Library Tools</button>
      <button class="tab" data-tab="email">Email</button>
      <button class="tab" data-tab="system">System</button>
      <button class="tab" data-tab="about">About</button>
    </div>

    <!-- ── General tab ──────────────────────────────── -->
    <div class="tab-panel active" id="tab-general">
      <div id="settingsContainer">
        <div class="spinner"></div>
      </div>

      <!-- Content Filter section -->
      <div class="card" style="padding:24px;margin-top:24px">
        <h3 class="settings-section-title">Content Filter</h3>
        <p style="color:var(--text-dim);font-size:.85rem;margin-bottom:16px">
          The profanity filter toggle is in the Requests section above.
          A built-in list of common English and Filipino offensive words is always active when the filter is enabled.
          Add your own station-specific blocked words below.
        </p>
        <div class="settings-field">
          <label>Custom blocked words <span style="color:var(--text-dim);font-weight:400">(comma-separated)</span></label>
          <textarea id="blockedWords" rows="3" placeholder="e.g. spam, promo, inappropriate-term" style="margin-bottom:0;width:100%;resize:vertical;font-family:inherit;font-size:.9rem"></textarea>
        </div>
        <button id="btnSaveBlockedWords" class="btn btn-primary btn-sm" style="margin-top:12px" onclick="RendezVoxSettings.saveBlockedWords()">Save Blocked Words</button>
      </div>
    </div>

    <!-- ── Appearance tab ─────────────────────────── -->
    <div class="tab-panel" id="tab-appearance">

      <!-- Theme picker -->
      <div class="card" style="padding:24px">
        <h3 class="settings-section-title">Theme</h3>
        <p style="color:var(--text-dim);font-size:.85rem;margin-bottom:16px">
          Choose a theme for the admin panel. This preference is saved locally in your browser.
        </p>
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
          <select id="themeSelect" style="margin-bottom:0;max-width:300px"></select>
          <div id="themePreviewDot" style="width:20px;height:20px;border-radius:50%;border:2px solid var(--border);flex-shrink:0"></div>
        </div>

        <hr style="border:none;border-top:1px solid var(--border);margin:24px 0">

        <h3 class="settings-section-title">Accent Color</h3>
        <p style="color:var(--text-dim);font-size:.85rem;margin-bottom:16px">
          Override the accent color used for highlights and buttons.
        </p>
        <div style="display:flex;align-items:center;gap:12px">
          <input type="color" id="accentColorPicker" style="width:40px;height:40px;padding:0;border:2px solid var(--border);border-radius:6px;cursor:pointer;background:none">
          <input type="text" id="accentColorHex" placeholder="#ff7800" maxlength="7" style="max-width:120px;margin-bottom:0">
          <button class="btn btn-ghost btn-sm" id="btnResetAccent">Reset</button>
        </div>
      </div>

    </div>

    <!-- ── Library Tools tab ────────────────────────── -->
    <div class="tab-panel" id="tab-tools">

      <!-- Scan and Tag -->
      <div class="card" style="padding:24px">
        <h3 class="settings-section-title">Scan and Tag</h3>
        <p style="color:var(--text-dim);font-size:.85rem;margin-bottom:16px">
          Scan all songs and look up metadata (genre/category) from MusicBrainz, TheAudioDB, and audio file tags.
          Fixes missing titles from filenames. Songs without a match keep their current values.
        </p>
        <div class="settings-field" style="margin-bottom:16px">
          <label>Auto-tag new songs</label>
          <div style="display:flex;align-items:center;gap:12px">
            <label class="toggle">
              <input type="checkbox" id="autoTagEnabled">
              <span class="slider"></span>
            </label>
            <span style="color:var(--text-dim);font-size:.8rem">Automatically tag unprocessed songs every 15 minutes</span>
          </div>
          <div id="autoTagStatus" style="margin-top:8px;font-size:.8rem;color:var(--text-dim)"></div>
        </div>
        <div class="settings-field">
          <label>AcoustID API key <span style="color:var(--text-dim);font-weight:400">(optional — enables audio fingerprinting)</span></label>
          <div style="font-size:.78rem;color:var(--text-dim);margin-bottom:4px">Get a free key at <a href="https://acoustid.org/new-application" target="_blank" rel="noopener" style="color:var(--accent)">acoustid.org/new-application</a></div>
          <div style="display:flex;gap:8px;align-items:flex-start">
            <div class="eye-wrap" style="flex:1">
              <input type="password" id="acoustidApiKey" placeholder="Paste your API key here" style="padding-right:36px;width:100%">
              <button type="button" class="eye-toggle" onclick="RendezVoxSettings.toggleVis('acoustidApiKey',this)" title="Show/hide API key" aria-label="Toggle API key visibility">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg>
              </button>
            </div>
            <button id="btnSaveApiKey" class="btn btn-ghost btn-sm" style="white-space:nowrap" onclick="RendezVoxSettings.saveApiKey()">Save Key</button>
          </div>
        </div>
        <div class="settings-field">
          <label>TheAudioDB API key <span style="color:var(--text-dim);font-weight:400">(optional — enables cover art from TheAudioDB)</span></label>
          <div style="font-size:.78rem;color:var(--text-dim);margin-bottom:4px">Free tier key is <code>2</code>. Get your own at <a href="https://www.theaudiodb.com/api_guide.php" target="_blank" rel="noopener" style="color:var(--accent)">theaudiodb.com</a></div>
          <div style="display:flex;gap:8px;align-items:flex-start">
            <div class="eye-wrap" style="flex:1">
              <input type="password" id="theAudioDbApiKey" placeholder="Default &quot;2&quot; is free tier" style="padding-right:36px;width:100%">
              <button type="button" class="eye-toggle" onclick="RendezVoxSettings.toggleVis('theAudioDbApiKey',this)" title="Show/hide API key" aria-label="Toggle API key visibility">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg>
              </button>
            </div>
            <button id="btnSaveTheAudioDbKey" class="btn btn-ghost btn-sm" style="white-space:nowrap" onclick="RendezVoxSettings.saveTheAudioDbKey()">Save Key</button>
          </div>
        </div>
        <div id="genreScanStatus" style="display:none;margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;font-size:.85rem;margin-bottom:4px">
            <span id="genreScanLabel">Scanning…</span>
            <span id="genreScanPct">0%</span>
          </div>
          <div style="background:var(--bg-input);border-radius:4px;height:8px;overflow:hidden">
            <div id="genreScanBar" style="background:var(--accent);height:100%;width:0;transition:width .3s"></div>
          </div>
          <div style="font-size:.8rem;color:var(--text-dim);margin-top:6px">
            <span id="genreScanDetails"></span>
          </div>
        </div>
        <button id="btnGenreScan" class="btn btn-primary btn-sm" onclick="RendezVoxSettings.startGenreScan()">Scan and Tag</button>
        <button id="btnStopScan" class="btn btn-sm hidden" style="background:var(--danger);color:#fff;margin-left:8px" onclick="RendezVoxSettings.stopGenreScan()">Stop</button>
      </div>

      <!-- Library Sync -->
      <div class="card" style="padding:24px;margin-top:24px">
        <h3 class="settings-section-title">Library Sync</h3>
        <p style="color:var(--text-dim);font-size:.85rem;margin-bottom:16px">
          Scan all active songs and check that their files still exist on disk.
          Missing files are deactivated (not deleted) so Liquidsoap won't try to play them.
        </p>
        <div class="settings-field" style="margin-bottom:16px">
          <label>Auto-sync library</label>
          <div style="display:flex;align-items:center;gap:12px">
            <label class="toggle">
              <input type="checkbox" id="autoSyncEnabled">
              <span class="slider"></span>
            </label>
            <span style="color:var(--text-dim);font-size:.8rem">Automatically check for missing files every 15 minutes</span>
          </div>
          <div id="autoSyncStatus" style="margin-top:8px;font-size:.8rem;color:var(--text-dim)"></div>
        </div>
        <div id="librarySyncStatus" style="display:none;margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;font-size:.85rem;margin-bottom:4px">
            <span id="librarySyncLabel">Syncing…</span>
            <span id="librarySyncPct">0%</span>
          </div>
          <div style="background:var(--bg-input);border-radius:4px;height:8px;overflow:hidden">
            <div id="librarySyncBar" style="background:var(--accent);height:100%;width:0;transition:width .3s"></div>
          </div>
          <div style="font-size:.8rem;color:var(--text-dim);margin-top:6px">
            <span id="librarySyncDetails"></span>
          </div>
        </div>
        <button id="btnLibrarySync" class="btn btn-primary btn-sm" onclick="RendezVoxSettings.startLibrarySync()">Sync Library</button>
        <button id="btnStopSync" class="btn btn-sm hidden" style="background:var(--danger);color:#fff;margin-left:8px" onclick="RendezVoxSettings.stopLibrarySync()">Stop</button>
      </div>

      <!-- Artist Cleanup -->
      <div class="card" style="padding:24px;margin-top:24px">
        <h3 class="settings-section-title">Artist Cleanup</h3>
        <p style="color:var(--text-dim);font-size:.85rem;margin-bottom:16px">
          Merge duplicate artists created from collaboration tags (feat., &amp;, with).
          Takes the primary artist and reassigns songs. Duo names like "Brooks &amp; Dunn" are preserved.
        </p>
        <div class="settings-field" style="margin-bottom:16px">
          <label>Auto-deduplicate artists</label>
          <div style="display:flex;align-items:center;gap:12px">
            <label class="toggle">
              <input type="checkbox" id="autoDedupEnabled">
              <span class="slider"></span>
            </label>
            <span style="color:var(--text-dim);font-size:.8rem">Automatically merge duplicate artists every 15 minutes</span>
          </div>
          <div id="autoDedupStatus" style="margin-top:8px;font-size:.8rem;color:var(--text-dim)"></div>
        </div>
        <div id="artistDedupStatus" style="display:none;margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;font-size:.85rem;margin-bottom:4px">
            <span id="artistDedupLabel">Deduplicating…</span>
            <span id="artistDedupPct">0%</span>
          </div>
          <div style="background:var(--bg-input);border-radius:4px;height:8px;overflow:hidden">
            <div id="artistDedupBar" style="background:var(--accent);height:100%;width:0;transition:width .3s"></div>
          </div>
          <div style="font-size:.8rem;color:var(--text-dim);margin-top:6px">
            <span id="artistDedupDetails"></span>
          </div>
        </div>
        <button id="btnArtistDedup" class="btn btn-primary btn-sm" onclick="RendezVoxSettings.startArtistDedup()">Deduplicate Artists</button>
        <button id="btnStopDedup" class="btn btn-sm hidden" style="background:var(--danger);color:#fff;margin-left:8px" onclick="RendezVoxSettings.stopArtistDedup()">Stop</button>
      </div>

      <!-- Audio Normalization -->
      <div class="card" style="padding:24px;margin-top:24px">
        <h3 class="settings-section-title">Audio Normalization</h3>
        <p style="color:var(--text-dim);font-size:.85rem;margin-bottom:16px">
          Analyze loudness (LUFS) of all songs and calculate per-track gain for consistent volume.
          Gain is applied in real-time during playback — no files are modified.
        </p>
        <div class="settings-field" style="margin-bottom:16px">
          <label>Auto-normalize new songs</label>
          <div style="display:flex;align-items:center;gap:12px">
            <label class="toggle">
              <input type="checkbox" id="autoNormEnabled">
              <span class="slider"></span>
            </label>
            <span style="color:var(--text-dim);font-size:.8rem">Automatically normalize unanalyzed songs every 15 minutes</span>
          </div>
          <div id="autoNormStatus" style="margin-top:8px;font-size:.8rem;color:var(--text-dim)"></div>
        </div>
        <div class="settings-field" style="margin-bottom:16px">
          <label>Target loudness (LUFS)</label>
          <select id="normTargetLufs" style="margin-bottom:0;max-width:260px">
            <option value="-23.0">-23.0 LUFS (broadcast standard)</option>
            <option value="-16.0">-16.0 LUFS (streaming)</option>
            <option value="-14.0">-14.0 LUFS (default)</option>
            <option value="-11.0">-11.0 LUFS (loud / club)</option>
          </select>
        </div>
        <div id="normStatus" style="display:none;margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;font-size:.85rem;margin-bottom:4px">
            <span id="normLabel">Analyzing…</span>
            <span id="normPct">0%</span>
          </div>
          <div style="background:var(--bg-input);border-radius:4px;height:8px;overflow:hidden">
            <div id="normBar" style="background:var(--accent);height:100%;width:0;transition:width .3s"></div>
          </div>
          <div style="font-size:.8rem;color:var(--text-dim);margin-top:6px">
            <span id="normDetails"></span>
          </div>
        </div>
        <button id="btnNormalize" class="btn btn-primary btn-sm" onclick="RendezVoxSettings.startNormalize()">Normalize</button>
        <button id="btnStopNorm" class="btn btn-sm hidden" style="background:var(--danger);color:#fff;margin-left:8px" onclick="RendezVoxSettings.stopNormalize()">Stop</button>
      </div>

      <!-- Path Rename -->
      <div class="card" style="padding:24px;margin-top:24px">
        <h3 class="settings-section-title">Path Rename</h3>
        <p style="color:var(--text-dim);font-size:.85rem;margin-bottom:16px">
          Rename directories and files to proper title case (e.g. "80s COUNTRY MUSIC" &rarr; "80s Country Music").
          Each rename updates the database immediately so the stream is never interrupted.
        </p>
        <div class="settings-field" style="margin-bottom:16px">
          <label>Auto-rename paths</label>
          <div style="display:flex;align-items:center;gap:12px">
            <label class="toggle">
              <input type="checkbox" id="autoRenameEnabled">
              <span class="slider"></span>
            </label>
            <span style="color:var(--text-dim);font-size:.8rem">Automatically rename new paths every 15 minutes</span>
          </div>
          <div id="autoRenameStatus" style="margin-top:8px;font-size:.8rem;color:var(--text-dim)"></div>
        </div>
        <div id="renameStatus" style="display:none;margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;font-size:.85rem;margin-bottom:4px">
            <span id="renameLabel">Renaming…</span>
            <span id="renamePct">0%</span>
          </div>
          <div style="background:var(--bg-input);border-radius:4px;height:8px;overflow:hidden">
            <div id="renameBar" style="background:var(--accent);height:100%;width:0;transition:width .3s"></div>
          </div>
          <div style="font-size:.8rem;color:var(--text-dim);margin-top:6px">
            <span id="renameDetails"></span>
          </div>
        </div>
        <button id="btnRenamePaths" class="btn btn-primary btn-sm" onclick="RendezVoxSettings.startRenamePaths()">Rename Paths</button>
        <button id="btnStopRename" class="btn btn-sm hidden" style="background:var(--danger);color:#fff;margin-left:8px" onclick="RendezVoxSettings.stopRenamePaths()">Stop</button>
      </div>

    </div>

    <!-- ── Email tab ────────────────────────────────── -->
    <div class="tab-panel" id="tab-email">
      <div class="card" style="padding:24px">
        <h3 class="settings-section-title">Email (SMTP)</h3>
        <p style="color:var(--text-dim);font-size:.85rem;margin-bottom:16px">
          Configure SMTP for password reset emails and notifications.
        </p>
        <div class="settings-field">
          <label>SMTP Host</label>
          <input type="text" id="smtpHost" placeholder="e.g. smtp.gmail.com" style="margin-bottom:0">
        </div>
        <div style="display:flex;gap:16px;margin-top:12px">
          <div class="settings-field" style="flex:1">
            <label>Port</label>
            <select id="smtpPort" style="margin-bottom:0">
              <option value="587">587 (STARTTLS)</option>
              <option value="465">465 (SSL)</option>
              <option value="25">25 (Plain)</option>
            </select>
          </div>
          <div class="settings-field" style="flex:1">
            <label>Encryption</label>
            <select id="smtpEncryption" style="margin-bottom:0">
              <option value="tls">STARTTLS</option>
              <option value="ssl">SSL/TLS</option>
              <option value="none">None</option>
            </select>
          </div>
        </div>
        <div style="display:flex;gap:16px;margin-top:12px">
          <div class="settings-field" style="flex:1">
            <label>Username</label>
            <input type="text" id="smtpUsername" placeholder="SMTP login" style="margin-bottom:0" autocomplete="off">
          </div>
          <div class="settings-field" style="flex:1">
            <label>Password</label>
            <div class="eye-wrap">
              <input type="password" id="smtpPassword" placeholder="SMTP password" style="padding-right:36px;width:100%" autocomplete="off">
              <button type="button" class="eye-toggle" onclick="RendezVoxSettings.toggleVis('smtpPassword',this)" title="Show/hide password" aria-label="Toggle password visibility">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg>
              </button>
            </div>
          </div>
        </div>
        <div style="display:flex;gap:16px;margin-top:12px">
          <div class="settings-field" style="flex:1">
            <label>From Address</label>
            <input type="email" id="smtpFromAddress" placeholder="noreply@example.com" style="margin-bottom:0">
          </div>
          <div class="settings-field" style="flex:1">
            <label>From Name</label>
            <input type="text" id="smtpFromName" placeholder="RendezVox" style="margin-bottom:0">
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:16px">
          <button class="btn btn-primary btn-sm" onclick="RendezVoxSettings.saveSmtp()">Save SMTP Settings</button>
          <button class="btn btn-ghost btn-sm" onclick="RendezVoxSettings.sendTestEmail()">Send Test Email</button>
        </div>
        <div id="smtpTestStatus" style="margin-top:8px;font-size:.8rem;color:var(--text-dim)"></div>
      </div>
    </div>

    <!-- ── System tab ────────────────────────────────── -->
    <div class="tab-panel" id="tab-system">
      <div class="card" style="padding:24px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h3 class="settings-section-title" style="margin-bottom:0">System Information</h3>
          <button class="btn btn-ghost btn-sm" id="btnRefreshSystem" style="font-size:.75rem">Refresh</button>
        </div>
        <div id="systemInfoContainer">
          <div class="spinner"></div>
        </div>
      </div>
    </div>

    <!-- ── About tab ────────────────────────────────── -->
    <div class="tab-panel" id="tab-about">
      <div class="card" style="padding:24px">
        <h3 class="settings-section-title">About</h3>
        <p style="color:var(--text-dim);font-size:.9rem;line-height:1.7;margin-bottom:16px">
          <strong id="aboutStationName" style="font-size:1.1rem;color:var(--text)">RendezVox</strong><br>
          A hybrid online streaming platform that works like an FM radio station &mdash;
          fully self-hosted, with automated playlists, live scheduling, song requests,
          and real-time playback powered by Liquidsoap and Icecast.
        </p>
        <span style="color:var(--text-dim);font-size:.8rem" id="aboutVersion"></span>

        <hr class="settings-divider">

        <h4 style="font-size:.85rem;color:var(--text);margin-bottom:8px">Developer</h4>
        <p style="color:var(--text-dim);font-size:.85rem;line-height:1.6;margin-bottom:16px">
          <strong style="color:var(--text)">Richard Ramirez Ayuyang, PhD</strong><br>
          Professor II, College of Information and Computing Sciences<br>
          Cagayan State University
        </p>

        <hr class="settings-divider">

        <h4 style="font-size:.85rem;color:var(--text);margin-bottom:8px">Through</h4>
        <p style="color:var(--text-dim);font-size:.85rem;line-height:1.6">
          <a href="https://downstreamtech.net" target="_blank" rel="noopener" style="color:var(--accent);font-weight:600">DownStreamTech</a><br>
          A Philippine-based startup empowering public institutions through affordable,
          locally-built open-source technology solutions. Serving local government units,
          schools, and government agencies with custom applications for document management,
          digital transformation, and IT infrastructure.
        </p>
      </div>
    </div>

    <!-- Sticky save bar -->
    <div id="saveBar" class="save-bar hidden">
      <span>You have unsaved changes</span>
      <div style="display:flex;gap:8px">
        <button class="btn btn-ghost btn-sm" onclick="RendezVoxSettings.cancelChanges()">Cancel</button>
        <button id="btnSaveAll" class="btn btn-primary btn-sm" onclick="RendezVoxSettings.saveAll()">Save Changes</button>
      </div>
    </div>
  </main>
</div>

<div class="toast-container" id="toasts"></div>

<script src="/assets/scroll-controls.js?v=20260225"></script>
<script src="/admin/js/api.js?v=20260225"></script>
<script src="/admin/js/auth.js?v=20260225"></script>
<script src="/admin/js/theme.js?v=20260225"></script>
<script src="/admin/js/nav.js?v=20260225e"></script>
<script src="/admin/js/settings.js?v=20260225e"></script>
<script>
  if (RendezVoxAuth.requireRole('super_admin')) {
    RendezVoxNav.init();
    RendezVoxSettings.init();
  }
</script>
</body>
</html>
