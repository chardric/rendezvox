<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Radio</title>
<meta name="description" content="Listen live, request songs, and see what's playing now.">
<meta name="theme-color" content="#141416">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Radio">
<link rel="manifest" href="/api/manifest.json">
<link rel="icon" type="image/svg+xml" href="/assets/icon.svg">
<link rel="icon" type="image/png" sizes="192x192" href="/assets/icon-192x192.png">
<link rel="apple-touch-icon" href="/assets/icon-192x192.png">
<script>
// Apply cached accent color synchronously to prevent flash
(function(){var a=localStorage.getItem('rendezvox_listener_accent');if(a&&/^#[0-9a-fA-F]{6}$/.test(a)){var r=document.documentElement;r.style.setProperty('--accent',a);var R=parseInt(a.slice(1,3),16),G=parseInt(a.slice(3,5),16),B=parseInt(a.slice(5,7),16);R=Math.min(255,Math.round(R+(255-R)*.18));G=Math.min(255,Math.round(G+(255-G)*.18));B=Math.min(255,Math.round(B+(255-B)*.18));r.style.setProperty('--accent-hover','#'+((1<<24)+(R<<16)+(G<<8)+B).toString(16).slice(1))}})();
</script>
<style>
:root{--accent:#ff7800;--accent-hover:#ff8c1a}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  background:#0a0a0c;color:#e0e0e0;
  display:flex;flex-direction:column;justify-content:center;align-items:center;
  min-height:100vh;position:relative;
  padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
}
.card{
  background:#141416;border-radius:16px;padding:20px 24px;
  width:100%;max-width:380px;text-align:center;
  box-shadow:0 8px 32px rgba(0,0,0,.4);
  position:relative;z-index:1;
}
.station-logo{width:80px;height:80px;object-fit:contain;border-radius:12px;margin:0 auto 10px;display:block}
.station-name{font-size:1.3rem;font-weight:700;color:#fff;margin-bottom:2px}
.tagline{font-size:.8rem;color:#666;margin-bottom:14px}

/* Turntable */
.turntable{
  position:relative;width:195px;margin:0 auto 4px;cursor:pointer;
  -webkit-tap-highlight-color:transparent;user-select:none;
}
.turntable:active{transform:scale(.97)}
/* Fixed specular sheen — stationary light band over spinning vinyl */
.turntable::before{
  content:'';position:absolute;
  width:150px;height:150px;border-radius:50%;
  top:0;left:50%;transform:translateX(-50%);
  background:linear-gradient(135deg,transparent 35%,rgba(255,255,255,.08) 46%,rgba(255,255,255,.16) 50%,rgba(255,255,255,.08) 54%,transparent 65%);
  z-index:1;pointer-events:none;
}

/* Vinyl record */
.vinyl-wrap{
  width:150px;height:150px;border-radius:50%;margin:0 auto;
  position:relative;
  background:
    conic-gradient(from 30deg,
      transparent 0%,rgba(255,255,255,.1) 8%,transparent 18%,
      rgba(255,255,255,.08) 30%,transparent 42%,
      rgba(255,255,255,.12) 55%,transparent 65%,
      rgba(255,255,255,.06) 78%,transparent 90%),
    radial-gradient(circle,transparent 21%,rgba(255,255,255,.08) 21.3%,transparent 21.8%,
    transparent 30%,rgba(255,255,255,.06) 30.3%,transparent 30.8%,
    transparent 39%,rgba(255,255,255,.08) 39.3%,transparent 39.8%,
    transparent 48%,rgba(255,255,255,.05) 48.3%,transparent 48.8%,
    transparent 55%,rgba(255,255,255,.07) 55.3%,transparent 55.8%,
    transparent 65%,rgba(255,255,255,.08) 65.3%,transparent 65.8%,
    transparent 75%,rgba(255,255,255,.06) 75.3%,transparent 75.8%,
    transparent 85%,rgba(255,255,255,.08) 85.3%,transparent 85.8%,
    transparent 93%,rgba(255,255,255,.06) 93.3%,transparent 93.8%),
    radial-gradient(circle,#222 22%,#181818 50%,#111 80%,#0a0a0a);
  box-shadow:0 4px 20px rgba(0,0,0,.5),inset 0 0 5px rgba(255,255,255,.06);
}
.vinyl-wrap.spinning{animation:vinyl-spin 4s linear infinite}
@keyframes vinyl-spin{to{transform:rotate(360deg)}}
.vinyl-label{
  position:absolute;width:44%;height:44%;border-radius:50%;
  top:50%;left:50%;transform:translate(-50%,-50%);
  overflow:hidden;z-index:1;
  background:var(--accent);
  display:flex;align-items:center;justify-content:center;
}
.vinyl-label img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.vinyl-hole{
  position:absolute;width:7px;height:7px;border-radius:50%;
  background:#000;top:50%;left:50%;transform:translate(-50%,-50%);z-index:2;
  box-shadow:inset 0 0 1px rgba(255,255,255,.15);
}

/* Tonearm */
.tonearm{
  position:absolute;width:32px;height:110px;
  top:-2px;right:5px;z-index:3;
  transform-origin:50% 10%;
  transform:rotate(-20deg) translateY(-2px);
  transition:transform .25s cubic-bezier(.4,0,.2,1);
  pointer-events:none;filter:drop-shadow(0 2px 4px rgba(0,0,0,.5));
}

/* Tonearm rest bracket */
.arm-rest{
  position:absolute;right:0;top:46px;z-index:2;
  width:14px;height:20px;
  pointer-events:none;
  filter:drop-shadow(0 1px 2px rgba(0,0,0,.5));
}

/* Play hint on vinyl */
.play-hint{
  position:absolute;top:50%;left:50%;width:36px;height:36px;
  transform:translate(-50%,-50%);z-index:4;pointer-events:none;
  opacity:.6;transition:opacity .3s ease;
}
.play-hint svg{width:100%;height:100%}
.turntable.is-playing .play-hint{opacity:0}

/* Now Playing */
.now-playing{margin-bottom:14px}
.song-title{font-size:1.05rem;font-weight:600;color:#fff;overflow:hidden;white-space:nowrap}
.song-artist{font-size:.875rem;color:#9ca3af;margin-top:3px;overflow:hidden;white-space:nowrap}
.not-playing{color:#555;font-style:italic}

/* Controls */
button{
  background:none;border:none;cursor:pointer;color:#e0e0e0;
  display:flex;align-items:center;justify-content:center;
}
button:hover{color:#fff}
.btn-sm{width:44px;height:44px}
.btn-sm svg{width:18px;height:18px}

/* Volume */
.volume-row{display:flex;align-items:center;gap:8px;justify-content:center;margin-bottom:14px}
.volume-slider{
  -webkit-appearance:none;appearance:none;
  width:120px;height:4px;background:#232326;border-radius:2px;outline:none;
}
.volume-slider::-webkit-slider-thumb{
  -webkit-appearance:none;width:13px;height:13px;
  background:var(--accent);border-radius:50%;cursor:pointer;
}
.volume-slider::-moz-range-thumb{
  width:13px;height:13px;background:var(--accent);border:none;border-radius:50%;cursor:pointer;
}

/* Up Next */
.up-next{font-size:.78rem;color:#555;margin-bottom:8px}
.up-next span{color:#9ca3af}

/* Dedication / request info */
.dedication{
  background:rgba(0,200,160,.1);border:1px solid rgba(0,200,160,.25);
  border-radius:8px;padding:8px 12px;margin-bottom:10px;
  font-size:.8rem;color:#c4b5fd;text-align:left;
  animation:fadeIn .3s ease;
}
.dedication.hidden{display:none}
.dedication .ded-label{font-size:.68rem;color:#888;text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px}
.dedication .ded-name{font-weight:600;color:#e0e0e0}
.dedication .ded-msg{margin-top:4px;font-style:italic;color:#a5b4fc}
@keyframes fadeIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}

/* Listeners */
.listeners{font-size:.78rem;color:#555;margin-bottom:12px}
.listeners span{color:#9ca3af}

/* Request button */
.btn-request{
  background:#1e1e22;color:#9ca3af;border:1px solid #232326;
  border-radius:8px;padding:10px 20px;font-size:.9rem;
  width:100%;cursor:pointer;transition:background .2s;
}
.btn-request:hover{background:#2a2a2e;color:#fff}

/* Download links */
.downloads{display:flex;align-items:center;justify-content:center;gap:16px;margin-top:10px}
.downloads a,.downloads button{
  display:flex;align-items:center;justify-content:center;
  width:44px;height:44px;border-radius:6px;transition:opacity .2s;
  text-decoration:none;
}
.downloads a:hover,.downloads button:hover{opacity:.8}
.downloads svg{width:20px;height:20px}

/* Footer */
.app-footer{
  text-align:center;padding:14px 16px 10px;font-size:.75rem;color:#9ca3af;
  display:flex;align-items:center;justify-content:center;gap:8px;
  position:relative;z-index:1;
}
.app-footer a{color:#9ca3af;text-decoration:underline}
.app-footer a:hover{color:#fff}
.info-btn{
  width:44px;height:44px;border-radius:50%;
  background:var(--accent);color:#fff;font-size:.9rem;font-weight:700;font-style:italic;
  font-family:Georgia,serif;
  display:inline-flex;align-items:center;justify-content:center;
  cursor:pointer;border:none;transition:background .2s;flex-shrink:0;
}
.info-btn:hover{background:var(--accent-hover);color:#fff}

/* About modal */
.about-desc{font-size:.85rem;color:#bbb;margin-bottom:14px;line-height:1.5;text-align:center}
.about-section{margin-bottom:12px}
.about-label{font-size:.7rem;color:#666;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;font-weight:600}
.about-section a{color:var(--accent);text-decoration:none;font-size:.85rem}
.about-section a:hover{text-decoration:underline}
.about-section div{font-size:.85rem;color:#ccc}

/* Schedule modal */
.sched-day{margin-bottom:14px}
.sched-day-title{font-size:.8rem;font-weight:700;color:#fff;margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
.sched-day-title .sched-today{font-size:.65rem;background:var(--accent);color:#fff;padding:1px 6px;border-radius:8px;margin-left:6px;text-transform:none;letter-spacing:0;vertical-align:middle}
.sched-block{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:6px;margin-bottom:4px;background:#1e1e22}
.sched-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.sched-time{font-size:.75rem;color:#888;white-space:nowrap}
.sched-name{font-size:.82rem;color:#e0e0e0;flex:1}
.sched-now{font-size:.6rem;background:var(--accent);color:#fff;padding:1px 5px;border-radius:6px;flex-shrink:0}
.sched-empty{color:#555;font-style:italic;font-size:.8rem;padding:4px 0}

/* Tap overlay */
.tap-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.85);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  z-index:100;cursor:pointer;
}
.tap-overlay.hidden{display:none}
.tap-text{font-size:1.4rem;color:#fff;font-weight:600}
.tap-sub{font-size:.85rem;color:#888;margin-top:8px}

/* Request modal */
.modal-backdrop{
  position:fixed;inset:0;background:rgba(0,0,0,.7);
  display:flex;align-items:center;justify-content:center;z-index:200;
}
.modal-backdrop.hidden{display:none}
.modal{
  background:#141416;border-radius:12px;padding:24px;
  width:90%;max-width:360px;
}
.modal h3{color:#fff;margin-bottom:16px;font-size:1.1rem}
.modal label{display:block;font-size:.85rem;color:#9ca3af;margin-bottom:4px;text-align:left}
.modal input,.modal textarea{
  width:100%;padding:8px 12px;background:#0a0a0c;border:1px solid #232326;
  border-radius:6px;color:#e0e0e0;font-size:.9rem;margin-bottom:12px;
  font-family:inherit;
}
.modal textarea{resize:vertical;min-height:60px}
.modal-actions{display:flex;gap:8px;justify-content:flex-end}
.modal-actions button{
  padding:8px 16px;border-radius:6px;font-size:.9rem;
}
.btn-cancel{background:#232326;color:#9ca3af}
.btn-cancel:hover{background:#444}
.btn-submit{background:var(--accent);color:#fff}
.btn-submit:hover{background:var(--accent-hover)}
.modal .msg{font-size:.85rem;margin-bottom:8px;text-align:center}
.msg-ok{color:#4ade80}
.msg-err{color:#f87171}

/* Suggestions dropdown */
.suggestions-wrap{position:relative}
.suggestions-list{
  position:absolute;left:0;right:0;top:100%;z-index:10;
  background:#18181b;border:1px solid #232326;border-radius:6px;
  max-height:200px;overflow-y:auto;list-style:none;
  margin-top:2px;
}
.suggestions-list.hidden{display:none}
.suggestions-list li{
  padding:8px 12px;cursor:pointer;border-bottom:1px solid #1e1e22;
}
.suggestions-list li:last-child{border-bottom:none}
.suggestions-list li:hover,.suggestions-list li.active{background:#1e1e22}
.suggestions-list .sg-title{color:#fff;font-size:.9rem}
.suggestions-list .sg-artist{color:#888;font-size:.8rem}

/* Resolved confirmation */
.req-resolved{
  background:#1a3a2a;border:1px solid #4ade80;border-radius:6px;
  padding:8px 12px;margin-bottom:12px;font-size:.85rem;color:#4ade80;
  display:flex;align-items:center;gap:8px;
}
.req-resolved.hidden{display:none}
.req-resolved .check-icon{flex-shrink:0}

/* Blurred cover art background */
#bgArt{
  position:fixed;inset:0;z-index:-1;
  background-size:cover;background-position:center;background-repeat:no-repeat;
  filter:blur(40px) brightness(.3);transform:scale(1.3);
  transition:opacity .8s ease;opacity:0;
}

/* Equalizer bars */
.eq-bars{display:flex;align-items:flex-end;justify-content:center;gap:3px;height:16px;margin:4px auto 6px}
.eq-bar{width:3px;height:16px;background:var(--accent);border-radius:1px;transform:scaleY(.2);transform-origin:bottom;opacity:.7}
.turntable.is-playing ~ .eq-bars .eq-bar{animation:eq-bar ease-in-out infinite alternate}
.turntable.is-playing ~ .eq-bars .eq-bar:nth-child(1){animation-duration:.7s;animation-delay:.1s}
.turntable.is-playing ~ .eq-bars .eq-bar:nth-child(2){animation-duration:.5s;animation-delay:.2s}
.turntable.is-playing ~ .eq-bars .eq-bar:nth-child(3){animation-duration:.6s;animation-delay:0s}
.turntable.is-playing ~ .eq-bars .eq-bar:nth-child(4){animation-duration:.8s;animation-delay:.15s}
.turntable.is-playing ~ .eq-bars .eq-bar:nth-child(5){animation-duration:.55s;animation-delay:.05s}
@keyframes eq-bar{from{transform:scaleY(.2)}to{transform:scaleY(1)}}

/* Marquee scroll for long titles */
.marquee-inner{display:inline-block;white-space:nowrap;animation:marquee-scroll 10s linear infinite}
@keyframes marquee-scroll{from{transform:translateX(0)}to{transform:translateX(-50%)}}

/* Song change animation */
@keyframes fadeSlideIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.song-changing{animation:fadeSlideIn .4s ease}

/* Recently played */
.history-section{margin-top:10px;margin-bottom:12px}
.history-toggle{
  font-size:.78rem;color:#555;cursor:pointer;user-select:none;
  display:flex;align-items:center;justify-content:center;gap:4px;
}
.history-toggle:hover{color:#9ca3af}
.history-arrow{transition:transform .3s ease;display:inline-block;font-size:.6rem}
.history-section.open .history-arrow{transform:rotate(180deg)}
.history-list{max-height:0;overflow:hidden;transition:max-height .4s ease}
.history-section.open .history-list{max-height:300px}
.history-item{
  display:flex;flex-direction:column;padding:5px 0;
  border-bottom:1px solid #1e1e22;font-size:.78rem;
}
.history-item:last-child{border-bottom:none}
.history-item .hi-title{color:#ccc}
.history-item .hi-artist{color:#666;font-size:.72rem}

/* Live listener badge */
.live-badge{
  display:none;align-items:center;gap:4px;
  font-size:.65rem;font-weight:700;color:#ff4444;letter-spacing:.5px;
  margin-right:6px;vertical-align:middle;
}
.live-badge::before{
  content:'';width:6px;height:6px;border-radius:50%;
  background:#ff4444;animation:live-pulse 1.5s ease-in-out infinite;
}
@keyframes live-pulse{0%,100%{opacity:1}50%{opacity:.3}}
.listeners.is-live #listenerCount{text-shadow:0 0 8px rgba(255,120,0,.4)}

/* Time-of-day ambient overlay */
body::after{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:radial-gradient(ellipse at center,var(--ambient,transparent),transparent 70%);
  transition:background 2s ease;
}

/* Listener EQ */
.btn-eq{
  width:32px;height:32px;border-radius:6px;
  background:none;border:1px solid #333;
  display:flex;align-items:center;justify-content:center;
  transition:background .2s;flex-shrink:0;
}
.btn-eq:hover{background:#232326}
.btn-eq svg{width:16px;height:16px}
.eq-modal .modal{max-width:340px;padding:16px 20px}
.eq-controls{display:flex;gap:8px;margin-bottom:14px}
.eq-ctrl-group{flex:1}
.eq-ctrl-group label{font-size:.7rem;color:#666;display:block;margin-bottom:3px}
.eq-ctrl-group select{
  width:100%;background:#0a0a0c;color:#e0e0e0;border:1px solid #232326;
  border-radius:6px;padding:6px 8px;font-size:.8rem;font-family:inherit;
}
.eq-sliders{display:flex;align-items:flex-end;justify-content:center;gap:0;margin:0 auto 8px}
.eq-band{display:flex;flex-direction:column;align-items:center;width:28px}
.eq-band input[type="range"]{
  writing-mode:vertical-lr;direction:rtl;
  height:80px;width:28px;accent-color:var(--accent);cursor:pointer;
}
.eq-band-label{font-size:.55rem;color:#666;margin-top:4px;white-space:nowrap}
.eq-band-val{font-size:.55rem;color:#888;margin-bottom:2px;min-height:11px;text-align:center}
.eq-reset-row{text-align:center;margin-top:8px}
.eq-reset-btn{
  background:#232326;color:#9ca3af;border:1px solid #333;border-radius:6px;
  padding:6px 14px;font-size:.78rem;cursor:pointer;transition:background .2s;
}
.eq-reset-btn:hover{background:#2a2a2e;color:#fff}
.eq-unavailable{text-align:center;color:#666;font-size:.85rem;padding:20px 0}
</style>
</head>
<body>

<div id="bgArt"></div>

<!-- Tap to listen overlay -->
<div class="tap-overlay hidden" id="tapOverlay">
  <div class="tap-text">Tap to Listen</div>
  <div class="tap-sub">Browser requires interaction to play audio</div>
</div>

<!-- Request modal -->
<div class="modal-backdrop hidden" id="requestModal">
  <div class="modal" style="position:relative">
    <button type="button" id="reqClose" style="position:absolute;top:10px;right:10px;background:none;border:none;color:#f87171;font-size:1.4rem;font-weight:700;cursor:pointer;line-height:1;padding:2px 6px">&times;</button>
    <h3>Request a Song</h3>
    <div style="font-size:.8rem;color:#666;margin-bottom:12px;text-align:center">Search by title, artist, or both</div>
    <div id="reqMsg"></div>
    <div id="reqResolved" class="req-resolved hidden">
      <span class="check-icon">&#10003;</span>
      <span id="reqResolvedText"></span>
    </div>
    <div class="suggestions-wrap">
      <label for="reqTitle">Song Title</label>
      <input type="text" id="reqTitle" placeholder="Start typing a song title..." autocomplete="off">
      <ul id="reqSuggestions" class="suggestions-list hidden"></ul>
    </div>
    <label for="reqArtist">Artist</label>
    <input type="text" id="reqArtist" placeholder="Artist name" autocomplete="off">
    <label for="reqName">Your Name (optional)</label>
    <input type="text" id="reqName" placeholder="Listener name" maxlength="100">
    <label for="reqMessage">Message (optional)</label>
    <textarea id="reqMessage" placeholder="Dedication or note" maxlength="500"></textarea>
    <div class="modal-actions">
      <button type="button" class="btn-cancel" id="reqCancel">Cancel</button>
      <button type="button" class="btn-submit" id="reqSubmit">Submit</button>
    </div>
  </div>
</div>

<!-- Player card -->
<div class="card">
  <img class="station-logo" id="stationLogo" src="/api/logo" alt="RendezVox" style="display:none">
  <div class="station-name" id="stationName">RendezVox</div>
  <div class="tagline">Online Radio</div>

  <div class="turntable" id="turntable">
    <div class="vinyl-wrap" id="vinylWrap">
      <div class="vinyl-label" id="vinylLabel"></div>
      <div class="vinyl-hole"></div>
    </div>
    <div class="play-hint" id="playHint">
      <svg viewBox="0 0 24 24" fill="rgba(255,255,255,.7)"><polygon points="8,4 20,12 8,20"/></svg>
    </div>
    <svg class="arm-rest" viewBox="0 0 14 22" fill="none">
      <defs>
        <linearGradient id="restMetal" x1="0" y1="0" x2="1" y2="0">
          <stop offset="0%" stop-color="#666"/>
          <stop offset="50%" stop-color="#aaa"/>
          <stop offset="100%" stop-color="#666"/>
        </linearGradient>
      </defs>
      <ellipse cx="7" cy="20" rx="5.5" ry="2" fill="#3a3a3a" stroke="#4a4a4a" stroke-width=".3"/>
      <rect x="5.5" y="8" width="3" height="13" rx="1" fill="url(#restMetal)"/>
      <path d="M3 9 C3 4 4.5 1.5 7 1.5 C9.5 1.5 11 4 11 9" stroke="url(#restMetal)" stroke-width="1.4" fill="none" stroke-linecap="round"/>
      <rect x="5" y="8" width="4" height="1.5" rx=".5" fill="#2a2a2a"/>
    </svg>
    <svg class="tonearm" id="tonearm" viewBox="0 0 40 138" fill="none">
      <defs>
        <linearGradient id="armMetal" x1="0" y1="0" x2="1" y2="0">
          <stop offset="0%" stop-color="#888"/>
          <stop offset="40%" stop-color="#ccc"/>
          <stop offset="60%" stop-color="#bbb"/>
          <stop offset="100%" stop-color="#777"/>
        </linearGradient>
      </defs>
      <ellipse cx="20" cy="5" rx="6" ry="4" fill="#444" stroke="#555" stroke-width=".5"/>
      <circle cx="20" cy="14" r="4" fill="#666"/>
      <circle cx="20" cy="14" r="2.5" fill="#555" stroke="#777" stroke-width=".5"/>
      <rect x="19" y="14" width="2.5" height="90" rx="1.2" fill="url(#armMetal)"/>
      <line x1="20.2" y1="104" x2="13" y2="114" stroke="#aaa" stroke-width="2.5" stroke-linecap="round"/>
      <rect x="9.5" y="112" width="8" height="4.5" rx="1" fill="#333" stroke="#555" stroke-width=".5"/>
      <circle cx="13.5" cy="119" r="1.3" fill="#e33"/>
    </svg>
  </div>
  <div class="eq-bars"><div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div></div>
  <div class="now-playing">
    <div class="song-title" id="songTitle">—</div>
    <div class="song-artist" id="songArtist">&nbsp;</div>
  </div>

  <div class="volume-row">
    <button type="button" class="btn-sm" id="btnMute" title="Mute / Unmute">
      <svg id="iconVol" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polygon points="11,5 6,9 2,9 2,15 6,15 11,19" fill="currentColor"/>
        <path d="M15.54 8.46a5 5 0 010 7.07"/>
        <path d="M19.07 4.93a10 10 0 010 14.14"/>
      </svg>
      <svg id="iconMuted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none">
        <polygon points="11,5 6,9 2,9 2,15 6,15 11,19" fill="currentColor"/>
        <line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/>
      </svg>
    </button>
    <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="80">
    <button type="button" class="btn-eq" id="btnEq" title="Equalizer"><svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><line x1="3" y1="17" x2="3" y2="3"/><circle cx="3" cy="7" r="2" fill="currentColor" stroke="none"/><line x1="10" y1="17" x2="10" y2="3"/><circle cx="10" cy="13" r="2" fill="currentColor" stroke="none"/><line x1="17" y1="17" x2="17" y2="3"/><circle cx="17" cy="9" r="2" fill="currentColor" stroke="none"/></svg></button>
  </div>

  <div class="up-next" id="upNext">Up Next: <span>—</span></div>
  <div class="dedication hidden" id="dedication">
    <div class="ded-label">Requested by</div>
    <div class="ded-name" id="dedName"></div>
    <div class="ded-msg" id="dedMsg"></div>
  </div>
  <div class="listeners" id="listeners"><span class="live-badge" id="liveBadge">LIVE</span> Listeners: <span id="listenerCount">—</span></div>

  <div class="history-section" id="historySection">
    <div class="history-toggle" id="historyToggle">Recently Played <span class="history-arrow">&#9662;</span></div>
    <div class="history-list" id="historyList"></div>
  </div>

  <button type="button" class="btn-request" id="btnRequest">Request a Song</button>
  <div class="downloads">
    <a id="dl-android" href="/installers/mobile/release/RendezVox-1.0.0.apk" title="Download for Android"><svg viewBox="0 0 24 24"><path fill="#3DDC84" d="M6 18c0 .55.45 1 1 1h1v3.5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5V19h2v3.5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5V19h1c.55 0 1-.45 1-1V7H6v11zM3.5 7C2.67 7 2 7.67 2 8.5v7c0 .83.67 1.5 1.5 1.5S5 16.33 5 15.5v-7C5 7.67 4.33 7 3.5 7zm17 0c-.83 0-1.5.67-1.5 1.5v7c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5v-7c0-.83-.67-1.5-1.5-1.5zm-4.97-5.84l1.3-1.3c.2-.2.2-.51 0-.71-.2-.2-.51-.2-.71 0l-1.48 1.48A5.84 5.84 0 0012 0c-.96 0-1.86.23-2.66.63L7.85.15c-.2-.2-.51-.2-.71 0-.2.2-.2.51 0 .71l1.31 1.31A5.983 5.983 0 006 6h12c0-2.21-1.2-4.15-2.97-5.18-.15-.09-.01.18 0 .16l-.5-.82zM10 4H9V3h1v1zm5 0h-1V3h1v1z"/></svg></a>
    <a id="dl-deb" href="/installers/desktop/linux/rendezvox_1.0.0_amd64.deb" title="Download for Linux (DEB)"><svg viewBox="0 0 24 24"><path fill="#333" d="M12 1C9.5 1 8 3.3 8 5.5c0 .9.2 1.7.6 2.4C6.5 9.5 5 12.5 5 15c0 2.5 1.2 4.2 3 5.2V21c0 .6.4 1 1 1h6c.6 0 1-.4 1-1v-.8c1.8-1 3-2.7 3-5.2 0-2.5-1.5-5.5-3.6-7.1.4-.7.6-1.5.6-2.4C16 3.3 14.5 1 12 1z"/><ellipse fill="#FFF" cx="12" cy="14" rx="3.2" ry="4.5"/><ellipse fill="#F0C674" cx="12" cy="6.5" rx="1.6" ry=".6"/><circle fill="#FFF" cx="10.5" cy="4.5" r=".9"/><circle fill="#FFF" cx="13.5" cy="4.5" r=".9"/><circle fill="#333" cx="10.8" cy="4.5" r=".45"/><circle fill="#333" cx="13.2" cy="4.5" r=".45"/><ellipse fill="#F0C674" cx="10" cy="22.3" rx="1.8" ry=".7"/><ellipse fill="#F0C674" cx="14" cy="22.3" rx="1.8" ry=".7"/></svg></a>
    <a id="dl-appimage" href="/installers/desktop/linux/RendezVox-1.0.0.AppImage" title="Download for Linux (AppImage)"><svg viewBox="0 0 24 24"><rect x="3" y="2" width="18" height="20" rx="2" fill="#444"/><rect x="5" y="4" width="14" height="12" rx="1" fill="#1a1a2e"/><path d="M12 7l3 4h-2v3h-2v-3H9l3-4z" fill="#4ec9b0"/><rect x="6" y="18" width="12" height="2" rx="1" fill="#666"/></svg></a>
    <a id="dl-windows" href="/installers/desktop/windows/RendezVox%20Setup%201.0.0.exe" title="Download for Windows"><svg viewBox="0 0 24 24"><path fill="#00ADEF" d="M0 3.449L9.75 2.1v9.451H0m10.949-9.602L24 0v11.4H10.949M0 12.6h9.75v9.451L0 20.699M10.949 12.6H24V24l-12.9-1.801"/></svg></a>
    <button type="button" id="btnSchedule" title="Weekly Schedule" style="background:none;border:none;cursor:pointer"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#9ca3af" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></button>
    <a href="https://github.com/chardric/rendezvox" target="_blank" rel="noopener" title="GitHub"><svg viewBox="0 0 24 24"><path fill="#9ca3af" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844a9.59 9.59 0 012.504.337c1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"/></svg></a>
    <button type="button" class="info-btn" id="btnAbout" title="About RendezVox">i</button>
  </div>
</div>

<script>
// Redirect logged-in admins to the dashboard instead of showing the listener page
(function(){
  if (new URLSearchParams(location.search).get('preview') === '1') return;
  var token = localStorage.getItem('rendezvox_token');
  if (!token) return;
  try {
    var payload = JSON.parse(atob(token.split('.')[1].replace(/-/g,'+').replace(/_/g,'/')));
    if (payload && payload.exp && payload.exp > Math.floor(Date.now() / 1000)) {
      window.location.replace('/admin/dashboard');
    }
  } catch (e) {}
})();
</script>
<script>
(function(){
  var audio     = new Audio();
  window._rvxAudio = audio;
  var streamUrl = '/stream/live';
  var iceUrl    = '/stream';
  var playing   = false;
  var userVol   = 0.8;
  var reconnecting   = false;
  var reconnectTimer = null;
  var stallTimer     = null;
  var stationName    = 'Radio';

  // Show station logo + dynamic favicon
  var logoEl = document.getElementById('stationLogo');
  if (logoEl) {
    logoEl.src = '/api/logo?v=' + Date.now();
    logoEl.onload = function() {
      logoEl.style.display = '';
      var fav = document.querySelector('link[rel="icon"]');
      if (fav) fav.href = logoEl.src;
    };
  }

  // Load station branding
  var accentHex = '#ff7800';
  fetch('/api/config', {cache:'no-store'}).then(function(r){ return r.json(); }).then(function(cfg) {
    stationName = cfg.station_name || 'RendezVox';
    document.getElementById('stationName').textContent = stationName;
    document.title = stationName;
    document.querySelector('meta[name="apple-mobile-web-app-title"]').setAttribute('content', stationName);
    // Apply server accent color and cache for instant load next time
    if (cfg.accent_color && /^#[0-9a-fA-F]{6}$/.test(cfg.accent_color)) {
      accentHex = cfg.accent_color;
      localStorage.setItem('rendezvox_listener_accent', accentHex);
      var root = document.documentElement;
      root.style.setProperty('--accent', accentHex);
      var r2 = parseInt(accentHex.slice(1,3),16), g2 = parseInt(accentHex.slice(3,5),16), b2 = parseInt(accentHex.slice(5,7),16);
      r2 = Math.min(255, Math.round(r2+(255-r2)*0.18)); g2 = Math.min(255, Math.round(g2+(255-g2)*0.18)); b2 = Math.min(255, Math.round(b2+(255-b2)*0.18));
      root.style.setProperty('--accent-hover', '#'+((1<<24)+(r2<<16)+(g2<<8)+b2).toString(16).slice(1));
      var themeMeta = document.querySelector('meta[name="theme-color"]');
      if (themeMeta) themeMeta.setAttribute('content', accentHex);
    }
    rebuildArtwork();
    updateMediaSession(null, null);
  }).catch(function() {});

  // Update download links from version API
  fetch('/api/version').then(function(r){ return r.json(); }).then(function(v) {
    var map = {
      'dl-android': v.downloads && v.downloads.android,
      'dl-deb': v.downloads && v.downloads.deb_amd64,
      'dl-appimage': v.downloads && v.downloads.appimage_x64,
      'dl-windows': v.downloads && v.downloads.windows
    };
    for (var id in map) {
      if (map[id]) {
        var el = document.getElementById(id);
        if (el) el.href = map[id];
      }
    }
  }).catch(function() {});

  var turntable    = document.getElementById('turntable');
  var tonearmEl    = document.getElementById('tonearm');
  var btnMute   = document.getElementById('btnMute');
  var iconVol   = document.getElementById('iconVol');
  var iconMuted = document.getElementById('iconMuted');
  var slider    = document.getElementById('volumeSlider');
  var overlay   = document.getElementById('tapOverlay');
  var titleEl      = document.getElementById('songTitle');
  var artistEl     = document.getElementById('songArtist');
  var upNextEl     = document.getElementById('upNext').querySelector('span');
  var dedEl        = document.getElementById('dedication');
  var dedNameEl    = document.getElementById('dedName');
  var dedMsgEl     = document.getElementById('dedMsg');
  var listenEl     = document.getElementById('listenerCount');
  var liveBadge    = document.getElementById('liveBadge');
  var bgArt        = document.getElementById('bgArt');
  var lastTitle    = '';
  var btnRequest   = document.getElementById('btnRequest');
  var vinylWrap    = document.getElementById('vinylWrap');
  var vinylLabel   = document.getElementById('vinylLabel');
  var lastCoverId  = null;

  // Progress state (updated by API poll, ticked locally every second)
  var songStartMs  = 0;   // when the current song started (epoch ms)
  var songDurMs    = 0;   // total song duration in ms

  // Parse PostgreSQL timestamp to epoch ms (no Date.parse — fully cross-browser)
  function parseTs(ts) {
    if (!ts) return 0;
    var m = ts.match(/(\d+)-(\d+)-(\d+)\D+(\d+):(\d+):(\d+)/);
    if (!m) return 0;
    var ms = Date.UTC(+m[1], m[2] - 1, +m[3], +m[4], +m[5], +m[6]);
    var tz = ts.match(/([+-])(\d{2})\s*$/);
    if (tz) ms -= (tz[1] === '+' ? 1 : -1) * parseInt(tz[2], 10) * 3600000;
    return ms;
  }

  audio.volume = userVol;

  // ── Media Session artwork (inline SVG data URI) ──
  var artworkList = [];
  function rebuildArtwork() {
    var svg = '<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512">'
      + '<rect width="512" height="512" rx="64" fill="#141416"/>'
      + '<circle cx="256" cy="240" r="120" fill="none" stroke="' + accentHex + '" stroke-width="12"/>'
      + '<circle cx="256" cy="240" r="40" fill="' + accentHex + '"/>'
      + '<line x1="256" y1="120" x2="256" y2="100" stroke="' + accentHex + '" stroke-width="8" stroke-linecap="round"/>'
      + '<circle cx="256" cy="88" r="10" fill="' + accentHex + '"/>'
      + '<text x="256" y="420" text-anchor="middle" font-family="sans-serif" font-size="56" font-weight="700" fill="#ffffff">' + stationName + '</text>'
      + '</svg>';
    var url = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
    artworkList = [{ src: url, sizes: '512x512', type: 'image/svg+xml' }];
  }
  rebuildArtwork();

  // ── Media Session helpers ──
  function updateMediaSession(title, artist) {
    if (!('mediaSession' in navigator)) return;
    navigator.mediaSession.metadata = new MediaMetadata({
      title:  title || stationName,
      artist: artist || 'Online Radio',
      album:  stationName,
      artwork: artworkList
    });
  }

  function updateMediaSessionState(state) {
    if (!('mediaSession' in navigator)) return;
    navigator.mediaSession.playbackState = state;
  }

  function initMediaSessionHandlers() {
    if (!('mediaSession' in navigator)) return;

    navigator.mediaSession.setActionHandler('play', function() {
      if (!playing) {
        audio.src = streamUrl + '?t=' + Date.now();
        audio.muted = false;
        audio.play();
        playing = true;
        updatePlayState();
        updateMuteIcon();
        updateMediaSessionState('playing');
      }
    });

    navigator.mediaSession.setActionHandler('pause', function() {
      if (playing || reconnecting) {
        playing = false;
        stopReconnect();
        audio.pause();
        audio.src = '';
        updatePlayState();
        updateMediaSessionState('paused');
      }
    });

    navigator.mediaSession.setActionHandler('stop', function() {
      if (playing || reconnecting) {
        playing = false;
        stopReconnect();
        audio.pause();
        audio.src = '';
        updatePlayState();
        updateMediaSessionState('none');
      }
    });
  }

  initMediaSessionHandlers();
  updateMediaSession(null, null);

  // ── Auto-play on load ──
  function startStream() {
    audio.src = streamUrl + '?t=' + Date.now();
    audio.load();
    var p = audio.play();
    if (p && p.catch) {
      p.then(function() {
        playing = true;
        updatePlayState();
        updateMediaSessionState('playing');
        overlay.classList.add('hidden');
      }).catch(function() {
        // Autoplay blocked — try muted
        audio.muted = true;
        audio.play().then(function() {
          playing = true;
          updatePlayState();
          updateMuteIcon();
          updateMediaSessionState('playing');
          overlay.classList.remove('hidden');
        }).catch(function() {
          // Fully blocked
          overlay.classList.remove('hidden');
        });
      });
    }
  }

  startStream();

  // ── Auto-reconnect when stream drops ──
  function onStreamLost() {
    if (playing && !reconnecting) {
      startReconnect();
    }
  }

  audio.addEventListener('error', onStreamLost);
  audio.addEventListener('ended', onStreamLost);

  // Stall detection — if audio stalls for 10s with no data, treat as stream lost
  audio.addEventListener('waiting', function() {
    if (playing && !reconnecting) {
      clearTimeout(stallTimer);
      stallTimer = setTimeout(function() {
        if (playing && !reconnecting) {
          startReconnect();
        }
      }, 10000);
    }
  });

  audio.addEventListener('playing', function() {
    clearTimeout(stallTimer);
    stallTimer = null;
    if (reconnecting) {
      stopReconnect();
      playing = true;
      updatePlayState();
      updateMediaSessionState('playing');
      fetchNowPlaying(); // immediately refresh song info after reconnect
    }
  });

  function startReconnect() {
    reconnecting = true;
    titleEl.textContent  = 'Reconnecting...';
    artistEl.textContent = 'Waiting for broadcast';
    updateMediaSession('Reconnecting...', stationName);
    updatePlayState();
    checkStreamStatus();
    tryReconnect();
    reconnectTimer = setInterval(tryReconnect, 2000);
  }

  function checkStreamStatus() {
    fetch('/api/now-playing').then(function(r) { return r.json(); }).then(function(data) {
      if (reconnecting && data.stream_active === false) {
        titleEl.textContent  = 'Off Air';
        artistEl.textContent = 'Station is not broadcasting';
        updateMediaSession('Off Air', stationName);
        // Reset turntable to idle state
        songStartMs = 0;
        songDurMs = 0;
        updateTonearm();
        updateCoverArt(null);
        updateDedication(null);
      }
    }).catch(function() {});
  }

  function tryReconnect() {
    checkStreamStatus();
    audio.src = streamUrl + '?t=' + Date.now();
    audio.load();
    var p = audio.play();
    if (p && p.catch) p.catch(function() {});
  }

  function stopReconnect() {
    reconnecting = false;
    clearInterval(reconnectTimer);
    reconnectTimer = null;
    clearTimeout(stallTimer);
    stallTimer = null;
    updatePlayState();
  }

  // ── Tap overlay ──
  overlay.addEventListener('click', function() {
    audio.muted = false;
    updateMuteIcon();
    if (!playing) {
      audio.src = streamUrl + '?t=' + Date.now();
      audio.play();
      playing = true;
    }
    overlay.classList.add('hidden');
    updatePlayState();
    updateMediaSessionState('playing');
  });

  // ── Play / Stop (turntable click) ──
  turntable.addEventListener('click', function() {
    if (playing || reconnecting) {
      playing = false;
      stopReconnect();
      clearTimeout(stallTimer);
      stallTimer = null;
      audio.pause();
      audio.src = '';
      updateMediaSessionState('paused');
    } else {
      audio.src = streamUrl + '?t=' + Date.now();
      audio.muted = false;
      audio.play();
      playing = true;
      updateMuteIcon();
      updateMediaSessionState('playing');
    }
    updatePlayState();
  });

  function updatePlayState() {
    var isLive = playing && !reconnecting;
    turntable.classList.toggle('is-playing', isLive);
    liveBadge.style.display = isLive ? 'inline-flex' : 'none';
    document.getElementById('listeners').classList.toggle('is-live', isLive);
    updateDiscSpin();
    updateTonearm();
  }

  function updateTonearm() {
    if ((!playing && !reconnecting) || !songStartMs || !songDurMs) {
      // Parked — swung right, off the record
      tonearmEl.style.transform = 'rotate(-20deg) translateY(-2px)';
      return;
    }
    var elapsed = Date.now() - songStartMs;
    if (elapsed < 0) elapsed = 0;
    if (elapsed > songDurMs) elapsed = songDurMs;
    var pct = elapsed / songDurMs;
    // Outer groove (0deg, vinyl rim) → inner groove (+20deg, near label)
    var angle = pct * 20;
    tonearmEl.style.transform = 'rotate(' + angle + 'deg)';
  }

  // ── Volume ──
  slider.addEventListener('input', function() {
    userVol = this.value / 100;
    audio.volume = userVol;
    if (userVol > 0 && audio.muted) {
      audio.muted = false;
      updateMuteIcon();
    }
  });

  // ── Mute toggle ──
  btnMute.addEventListener('click', function() {
    audio.muted = !audio.muted;
    updateMuteIcon();
  });

  function updateMuteIcon() {
    iconVol.style.display   = audio.muted ? 'none' : 'block';
    iconMuted.style.display = audio.muted ? 'block' : 'none';
  }

  // ── Request button visibility ──
  function updateRequestButton(isEmergency) {
    if (isEmergency) {
      btnRequest.textContent = 'Requests Unavailable';
      btnRequest.disabled = true;
      btnRequest.style.opacity = '0.4';
      btnRequest.style.cursor = 'default';
    } else {
      btnRequest.textContent = 'Request a Song';
      btnRequest.disabled = false;
      btnRequest.style.opacity = '';
      btnRequest.style.cursor = '';
    }
  }

  // ── Dedication / request display ──
  function updateDedication(req) {
    if (req && (req.listener_name || req.message)) {
      dedNameEl.textContent = req.listener_name || 'A listener';
      if (req.message) {
        dedMsgEl.textContent = '"' + req.message + '"';
        dedMsgEl.style.display = '';
      } else {
        dedMsgEl.style.display = 'none';
      }
      dedEl.classList.remove('hidden');
    } else {
      dedEl.classList.add('hidden');
    }
  }

  // ── Cover art (vinyl record style) ──
  function updateDiscSpin() {
    vinylWrap.classList.toggle('spinning', playing && !reconnecting);
  }

  function updateCoverArt(song) {
    var songId = (song && song.has_cover_art) ? song.id : null;
    if (songId === lastCoverId) return;
    lastCoverId = songId;
    bgArt.style.opacity = '0';
    if (!songId) {
      vinylLabel.innerHTML = '';
      artworkList = [];
      rebuildArtwork();
      setTimeout(function() { bgArt.style.backgroundImage = ''; }, 800);
      return;
    }
    var coverUrl = '/api/cover?id=' + songId;
    var img = new Image();
    img.onload = function() {
      vinylLabel.innerHTML = '';
      vinylLabel.appendChild(img);
      if ('mediaSession' in navigator && navigator.mediaSession.metadata) {
        navigator.mediaSession.metadata.artwork = [{ src: coverUrl, sizes: '512x512', type: 'image/jpeg' }];
      }
      bgArt.style.backgroundImage = 'url(' + coverUrl + ')';
      bgArt.style.opacity = '1';
    };
    img.onerror = function() {
      vinylLabel.innerHTML = '';
      bgArt.style.backgroundImage = '';
    };
    img.src = coverUrl;
    img.alt = 'Cover art';
  }

  // ── Marquee for long titles ──
  function checkMarquee(el) {
    // Already marqueed with same text — skip
    var existing = el.querySelector('.marquee-inner');
    if (existing) return;
    if (el.scrollWidth > el.clientWidth) {
      var text = el.textContent;
      var span = document.createElement('span');
      span.className = 'marquee-inner';
      span.textContent = text + '\u00a0\u00a0\u00a0\u00a0\u00a0' + text;
      el.textContent = '';
      el.appendChild(span);
    }
  }

  // ── Song change animation ──
  function triggerSongChange(newTitle) {
    if (newTitle && newTitle !== lastTitle && lastTitle !== '') {
      var np = document.querySelector('.now-playing');
      np.classList.remove('song-changing');
      void np.offsetWidth;
      np.classList.add('song-changing');
      np.addEventListener('animationend', function handler() {
        np.classList.remove('song-changing');
        np.removeEventListener('animationend', handler);
      });
    }
    lastTitle = newTitle || '';
  }

  // ── Now playing poll ──
  function fetchNowPlaying() {
    fetch('/api/now-playing').then(function(r){ return r.json(); }).then(function(data) {
      // Don't overwrite title/artist during reconnection
      if (!reconnecting) {
        if (data.song) {
          triggerSongChange(data.song.title);
          titleEl.textContent  = data.song.title;
          artistEl.textContent = data.song.artist;
          checkMarquee(titleEl);
          checkMarquee(artistEl);
          document.title = data.song.title + ' — ' + data.song.artist + ' | ' + stationName;
          updateMediaSession(data.song.title, data.song.artist);
          updateCoverArt(data.song);
          songStartMs = parseTs(data.started_at);
          songDurMs   = data.song.duration_ms || 0;
          tickProgress();
        } else {
          triggerSongChange('');
          titleEl.textContent  = '—';
          artistEl.innerHTML   = '&nbsp;';
          document.title = stationName;
          updateMediaSession(null, null);
          updateCoverArt(null);
          songStartMs = 0;
          songDurMs   = 0;
        }
      }
      if (data.next_track) {
        upNextEl.textContent = data.next_track.title + ' — ' + data.next_track.artist;
      } else {
        upNextEl.textContent = '—';
      }
      updateDedication(data.request);
      updateRequestButton(data.is_emergency);
    }).catch(function(){});
  }

  // ── Tonearm tick (runs every second) ──
  function tickProgress() {
    updateTonearm();
  }

  fetchNowPlaying();
  var nowPlayingPoll = setInterval(fetchNowPlaying, 30000);
  var tickInterval   = setInterval(tickProgress, 1000);

  // ── SSE real-time connection ──
  var sse = null;

  function handleSSE(e) {
    try {
      var data = JSON.parse(e.data);
      if (data.song && !reconnecting) {
        triggerSongChange(data.song.title);
        titleEl.textContent  = data.song.title;
        artistEl.textContent = data.song.artist;
        checkMarquee(titleEl);
        checkMarquee(artistEl);
        document.title = data.song.title + ' — ' + data.song.artist + ' | ' + stationName;
        updateMediaSession(data.song.title, data.song.artist);
        updateCoverArt(data.song);
        songStartMs = parseTs(data.song.started_at);
        songDurMs   = data.song.duration_ms || 0;
        tickProgress();
      }
      if (data.next_track) {
        upNextEl.textContent = data.next_track.title + ' — ' + data.next_track.artist;
      } else {
        upNextEl.textContent = '—';
      }
      updateDedication(data.request);
      if (typeof data.is_emergency !== 'undefined') {
        updateRequestButton(data.is_emergency);
      }
    } catch (err) {}
  }

  function connectSSE() {
    if (typeof EventSource === 'undefined') return;
    if (sse) return;
    sse = new EventSource('/api/sse/now-playing');
    sse.addEventListener('now-playing', handleSSE);
  }

  function disconnectSSE() {
    if (sse) { sse.close(); sse = null; }
  }

  connectSSE();

  // ── Listener count poll ──
  function fetchListeners() {
    fetch(iceUrl + '/status-json.xsl').then(function(r){ return r.json(); }).then(function(data) {
      var src = data.icestats && data.icestats.source;
      if (!src) { listenEl.textContent = '0'; return; }
      var sources = Array.isArray(src) ? src : [src];
      var mount = sources.find(function(s){ return s.listenurl && s.listenurl.indexOf('/live') !== -1; });
      listenEl.textContent = mount ? mount.listeners : '0';
    }).catch(function(){ listenEl.textContent = '—'; });
  }

  fetchListeners();
  var listenerPoll = setInterval(fetchListeners, 15000);

  // ── Pause polling when tab is hidden (saves battery) ──
  document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
      clearInterval(nowPlayingPoll);
      clearInterval(tickInterval);
      clearInterval(listenerPoll);
      if (historyInterval) clearInterval(historyInterval);
      disconnectSSE();
    } else {
      fetchNowPlaying();
      fetchListeners();
      nowPlayingPoll = setInterval(fetchNowPlaying, 30000);
      tickInterval   = setInterval(tickProgress, 1000);
      listenerPoll   = setInterval(fetchListeners, 15000);
      if (historyLoaded) historyInterval = setInterval(fetchRecentPlays, 60000);
      connectSSE();
    }
  });

  // ── Request modal ──
  var modal        = document.getElementById('requestModal');
  var reqMsg       = document.getElementById('reqMsg');
  var reqTitle     = document.getElementById('reqTitle');
  var reqArtist    = document.getElementById('reqArtist');
  var reqName      = document.getElementById('reqName');
  var reqMsgEl     = document.getElementById('reqMessage');
  var suggestions  = document.getElementById('reqSuggestions');
  var resolvedEl   = document.getElementById('reqResolved');
  var resolvedText = document.getElementById('reqResolvedText');
  var resolvedSong = null;
  var searchTimer  = null;
  var sgIdx        = -1;

  function resetReqForm() {
    reqMsg.innerHTML = '';
    reqTitle.value = '';
    reqArtist.value = '';
    reqName.value = '';
    reqMsgEl.value = '';
    resolvedSong = null;
    resolvedEl.classList.add('hidden');
    suggestions.classList.add('hidden');
    suggestions.innerHTML = '';
    sgIdx = -1;
  }

  document.getElementById('btnRequest').addEventListener('click', function() {
    resetReqForm();
    modal.classList.remove('hidden');
    reqTitle.focus();
  });

  document.getElementById('reqCancel').addEventListener('click', function() {
    modal.classList.add('hidden');
  });
  document.getElementById('reqClose').addEventListener('click', function() {
    modal.classList.add('hidden');
  });

  modal.addEventListener('click', function(e) {
    if (e.target === modal) modal.classList.add('hidden');
  });

  // ── Autocomplete search ──
  function doSearch() {
    var title = reqTitle.value.trim();
    var artist = reqArtist.value.trim();

    if (title.length < 2 && artist.length < 2) {
      suggestions.classList.add('hidden');
      resolvedSong = null;
      resolvedEl.classList.add('hidden');
      return;
    }

    var url = '/api/search-song?';
    var params = [];
    if (title)  params.push('title=' + encodeURIComponent(title));
    if (artist) params.push('artist=' + encodeURIComponent(artist));
    url += params.join('&');

    fetch(url).then(function(r){ return r.json(); }).then(function(data) {
      if (!data.songs || data.songs.length === 0) {
        suggestions.classList.add('hidden');
        resolvedSong = null;
        resolvedEl.classList.add('hidden');
        return;
      }

      if (data.resolved) {
        selectSong(data.songs[0]);
        suggestions.classList.add('hidden');
        return;
      }

      renderSuggestions(data.songs);
    }).catch(function(){});
  }

  function renderSuggestions(songs) {
    var html = '';
    songs.forEach(function(s, i) {
      html += '<li data-idx="' + i + '">'
        + '<div class="sg-title">' + escHtml(s.title) + '</div>'
        + '<div class="sg-artist">' + escHtml(s.artist) + '</div>'
        + '</li>';
    });
    suggestions.innerHTML = html;
    suggestions._songs = songs;
    suggestions.classList.remove('hidden');
    sgIdx = -1;

    var items = suggestions.querySelectorAll('li');
    items.forEach(function(li) {
      li.addEventListener('click', function() {
        var idx = parseInt(this.getAttribute('data-idx'), 10);
        selectSong(suggestions._songs[idx]);
        suggestions.classList.add('hidden');
      });
    });
  }

  function selectSong(song) {
    resolvedSong = song;
    reqTitle.value = song.title;
    reqArtist.value = song.artist;
    resolvedText.textContent = song.title + ' — ' + song.artist;
    resolvedEl.classList.remove('hidden');
    suggestions.classList.add('hidden');
  }

  function escHtml(str) {
    if (!str) return '';
    var d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }

  // Debounced search on title input
  reqTitle.addEventListener('input', function() {
    resolvedSong = null;
    resolvedEl.classList.add('hidden');
    clearTimeout(searchTimer);
    searchTimer = setTimeout(doSearch, 350);
  });

  // Re-search when artist changes
  reqArtist.addEventListener('input', function() {
    resolvedSong = null;
    resolvedEl.classList.add('hidden');
    clearTimeout(searchTimer);
    searchTimer = setTimeout(doSearch, 350);
  });

  // Keyboard navigation for suggestions + prevent accidental submit
  function handleSuggestionKeys(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      var items = suggestions.querySelectorAll('li');
      if (items.length && !suggestions.classList.contains('hidden')) {
        // Select highlighted item, or first item if none highlighted
        var idx = sgIdx >= 0 ? sgIdx : 0;
        selectSong(suggestions._songs[idx]);
        suggestions.classList.add('hidden');
      }
      return;
    }

    var items = suggestions.querySelectorAll('li');
    if (!items.length || suggestions.classList.contains('hidden')) return;

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      sgIdx = Math.min(sgIdx + 1, items.length - 1);
      updateSgActive(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      sgIdx = Math.max(sgIdx - 1, 0);
      updateSgActive(items);
    } else if (e.key === 'Escape') {
      suggestions.classList.add('hidden');
      sgIdx = -1;
    }
  }
  reqTitle.addEventListener('keydown', handleSuggestionKeys);
  reqArtist.addEventListener('keydown', handleSuggestionKeys);

  function updateSgActive(items) {
    items.forEach(function(li, i) {
      li.classList.toggle('active', i === sgIdx);
    });
    if (items[sgIdx]) items[sgIdx].scrollIntoView({ block: 'nearest' });
  }

  // Close suggestions when clicking outside
  document.addEventListener('click', function(e) {
    if (!suggestions.contains(e.target) && e.target !== reqTitle && e.target !== reqArtist) {
      suggestions.classList.add('hidden');
    }
  });

  // ── Submit request ──
  document.getElementById('reqSubmit').addEventListener('click', function() {
    var title = reqTitle.value.trim();
    var artist = reqArtist.value.trim();
    if (!title && !artist) {
      reqMsg.innerHTML = '<div class="msg msg-err">Enter a song title or artist name</div>';
      return;
    }

    var body = {};
    if (title) body.title = title;
    var name = reqName.value.trim();
    var msg  = reqMsgEl.value.trim();
    if (artist) body.artist = artist;
    if (name)   body.listener_name = name;
    if (msg)    body.message = msg;

    fetch('/api/request', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    }).then(function(r){ return r.json().then(function(d){ return {ok:r.ok, status:r.status, data:d}; }); })
      .then(function(res) {
        if (res.ok) {
          var s = res.data.song;
          reqMsg.innerHTML = '<div class="msg msg-ok">Requested: ' + escHtml(s.title) + ' — ' + escHtml(s.artist) + '</div>';
          setTimeout(function(){ modal.classList.add('hidden'); }, 2000);
        } else if (res.status === 422 && res.data.suggestions) {
          reqMsg.innerHTML = '<div class="msg msg-err">Multiple matches — please select one:</div>';
          renderSuggestions(res.data.suggestions);
        } else {
          reqMsg.innerHTML = '<div class="msg msg-err">' + escHtml(res.data.error || 'Request failed') + '</div>';
        }
      }).catch(function() {
        reqMsg.innerHTML = '<div class="msg msg-err">Network error</div>';
      });
  });

  // ── Recently played ──
  var historySection = document.getElementById('historySection');
  var historyToggle  = document.getElementById('historyToggle');
  var historyList    = document.getElementById('historyList');

  var historyLoaded = false;
  var historyInterval = null;

  historyToggle.addEventListener('click', function() {
    historySection.classList.toggle('open');
    if (!historyLoaded) {
      historyLoaded = true;
      fetchRecentPlays();
      historyInterval = setInterval(fetchRecentPlays, 60000);
    }
  });

  function fetchRecentPlays() {
    fetch('/api/recent-plays').then(function(r){ return r.json(); }).then(function(data) {
      if (!data.plays || !data.plays.length) {
        historyList.innerHTML = '<div style="font-size:.75rem;color:#555;padding:4px 0">No recent tracks</div>';
        return;
      }
      var html = '';
      data.plays.forEach(function(p) {
        html += '<div class="history-item"><span class="hi-title">' + escHtml(p.title) + '</span><span class="hi-artist">' + escHtml(p.artist) + '</span></div>';
      });
      historyList.innerHTML = html;
    }).catch(function(){});
  }

  // ── Time-of-day ambient color ──
  function updateAmbient() {
    var h = new Date().getHours();
    var color;
    if (h >= 20 || h < 5) color = 'rgba(20,30,80,.15)';
    else if (h >= 5 && h < 11) color = 'rgba(80,60,20,.12)';
    else if (h >= 11 && h < 16) color = 'transparent';
    else color = 'rgba(80,40,30,.12)';
    document.documentElement.style.setProperty('--ambient', color);
  }
  updateAmbient();
  setInterval(updateAmbient, 1800000);

  // ── Service worker registration ──
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js');
  }

})();
</script>
<footer class="app-footer">&copy; 2026 <a href="https://downstreamtech.net" target="_blank" rel="noopener">DownStreamTech</a>. All rights reserved.</footer>

<!-- About modal -->
<div class="modal-backdrop hidden" id="aboutModal">
  <div class="modal" style="text-align:left;position:relative">
    <button type="button" id="aboutClose" style="position:absolute;top:10px;right:10px;background:none;border:none;color:#f87171;font-size:1.4rem;font-weight:700;cursor:pointer;line-height:1;padding:2px 6px">&times;</button>
    <h3 style="text-align:center">About RendezVox</h3>
    <p class="about-desc">Your personal online FM radio station — stream music, request songs, and listen live from any device, anywhere.</p>
    <div class="about-section">
      <div class="about-label">Links</div>
      <a href="https://downstreamtech.net" target="_blank" rel="noopener">downstreamtech.net</a><br>
      <a href="https://radio.chadlinuxtech.net" target="_blank" rel="noopener">radio.chadlinuxtech.net</a>
    </div>
    <div class="about-section">
      <div class="about-label">Support</div>
      <div>Phone: <a href="tel:+639177927953">+639177927953</a></div>
      <div>Email: <a href="mailto:support@downstreamtech.net">support@downstreamtech.net</a></div>
    </div>
    <div class="about-section">
      <div class="about-label">Developer</div>
      <div>Engr. Richard R. Ayuyang, PhD</div>
      <div style="color:#666">Professor II, CSU</div>
    </div>
  </div>
</div>
<script>
(function(){
  var aboutModal = document.getElementById('aboutModal');
  document.getElementById('btnAbout').addEventListener('click', function() {
    aboutModal.classList.remove('hidden');
  });
  document.getElementById('aboutClose').addEventListener('click', function() {
    aboutModal.classList.add('hidden');
  });
  aboutModal.addEventListener('click', function(e) {
    if (e.target === aboutModal) aboutModal.classList.add('hidden');
  });
})();
</script>

<div class="modal-backdrop hidden" id="scheduleModal">
  <div class="modal" style="text-align:left;position:relative;max-width:420px;max-height:85vh;overflow-y:auto">
    <button type="button" id="scheduleClose" style="position:absolute;top:10px;right:10px;background:none;border:none;color:#f87171;font-size:1.4rem;font-weight:700;cursor:pointer;line-height:1;padding:2px 6px">&times;</button>
    <h3 style="text-align:center">Weekly Schedule</h3>
    <div id="scheduleContent" style="font-size:.85rem;color:#bbb">Loading...</div>
  </div>
</div>
<script>
(function(){
  var scheduleData = null;
  var schedModal = document.getElementById('scheduleModal');
  var dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];

  document.getElementById('btnSchedule').addEventListener('click', function() {
    schedModal.classList.remove('hidden');
    if (scheduleData) { renderSchedule(scheduleData); return; }
    fetch('/api/schedule').then(function(r){ return r.json(); }).then(function(data) {
      scheduleData = data.schedules || [];
      renderSchedule(scheduleData);
    }).catch(function() {
      document.getElementById('scheduleContent').textContent = 'Unable to load schedule.';
    });
  });

  document.getElementById('scheduleClose').addEventListener('click', function() {
    schedModal.classList.add('hidden');
  });
  schedModal.addEventListener('click', function(e) {
    if (e.target === schedModal) schedModal.classList.add('hidden');
  });

  function fmtTime(t) {
    var parts = t.split(':');
    var h = parseInt(parts[0], 10);
    var m = parts[1];
    var ampm = h >= 12 ? 'PM' : 'AM';
    h = h % 12 || 12;
    return h + ':' + m + ' ' + ampm;
  }

  function isNowActive(startTime, endTime) {
    var now = new Date();
    var tz = 'Asia/Manila';
    var fmt = new Intl.DateTimeFormat('en-US', {hour:'2-digit', minute:'2-digit', hour12:false, timeZone:tz});
    var nowStr = fmt.format(now);
    var nowParts = nowStr.split(':');
    var nowMin = parseInt(nowParts[0], 10) * 60 + parseInt(nowParts[1], 10);
    var sParts = startTime.split(':');
    var eParts = endTime.split(':');
    var sMin = parseInt(sParts[0], 10) * 60 + parseInt(sParts[1], 10);
    var eMin = parseInt(eParts[0], 10) * 60 + parseInt(eParts[1], 10);
    if (eMin <= sMin) {
      return nowMin >= sMin || nowMin < eMin;
    }
    return nowMin >= sMin && nowMin < eMin;
  }

  function renderSchedule(schedules) {
    var now = new Date();
    var tz = 'Asia/Manila';
    var todayDay = parseInt(new Intl.DateTimeFormat('en-US', {weekday:'narrow', timeZone:tz}).formatToParts(now).find(function(p){return p.type==='weekday'}).value, 10);
    // weekday narrow gives single char, use full day detection
    var todayDow = new Date(now.toLocaleString('en-US', {timeZone:tz})).getDay();

    // Group by day
    var byDay = {};
    for (var d = 0; d < 7; d++) byDay[d] = [];
    schedules.forEach(function(s) {
      var days = s.days_of_week;
      if (days === null) {
        for (var d = 0; d < 7; d++) byDay[d].push(s);
      } else {
        days.forEach(function(d){ if (byDay[d]) byDay[d].push(s); });
      }
    });

    var html = '';
    if (schedules.length === 0) {
      html = '<p class="sched-empty">No schedules configured.</p>';
    } else {
      for (var i = 0; i < 7; i++) {
        var dow = (todayDow + i) % 7;
        var isToday = i === 0;
        var items = byDay[dow];
        html += '<div class="sched-day"><div class="sched-day-title">' + dayNames[dow];
        if (isToday) html += ' <span class="sched-today">TODAY</span>';
        html += '</div>';
        if (items.length === 0) {
          html += '<div class="sched-empty">No scheduled programs</div>';
        } else {
          items.forEach(function(s) {
            var color = s.playlist_color || '#666';
            var showNow = isToday && isNowActive(s.start_time, s.end_time);
            html += '<div class="sched-block">';
            html += '<span class="sched-dot" style="background:' + color + '"></span>';
            html += '<span class="sched-time">' + fmtTime(s.start_time) + ' – ' + fmtTime(s.end_time) + '</span>';
            html += '<span class="sched-name">' + escHtml(s.name || s.playlist_name) + '</span>';
            if (showNow) html += '<span class="sched-now">NOW</span>';
            html += '</div>';
          });
        }
        html += '</div>';
      }
    }
    document.getElementById('scheduleContent').innerHTML = html;
  }

  function escHtml(s) {
    var d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }
})();
</script>

<!-- EQ modal -->
<div class="modal-backdrop hidden eq-modal" id="eqModal">
  <div class="modal" style="position:relative">
    <button type="button" id="eqClose" style="position:absolute;top:10px;right:10px;background:none;border:none;color:#f87171;font-size:1.4rem;font-weight:700;cursor:pointer;line-height:1;padding:2px 6px">&times;</button>
    <h3 style="text-align:center">Equalizer</h3>
    <div id="eqUnavailable" class="eq-unavailable" style="display:none">EQ requires audio playback to be active.</div>
    <div id="eqControls">
      <div class="eq-controls">
        <div class="eq-ctrl-group">
          <label>Preset</label>
          <select id="eqPresetSel">
            <option value="flat">Flat</option>
            <option value="bass_boost">Bass Boost</option>
            <option value="treble_boost">Treble Boost</option>
            <option value="vocal">Vocal</option>
            <option value="rock">Rock</option>
            <option value="pop">Pop</option>
            <option value="jazz">Jazz</option>
            <option value="classical">Classical</option>
            <option value="loudness">Loudness</option>
            <option value="small_speakers">Small Speakers</option>
            <option value="earphones">Earphones</option>
            <option value="headphones">Headphones</option>
            <option value="custom">Custom</option>
          </select>
        </div>
        <div class="eq-ctrl-group">
          <label>Spatial</label>
          <select id="eqSpatialSel">
            <option value="off">Off</option>
            <option value="stereo_wide">Stereo Wide</option>
            <option value="surround">Surround</option>
            <option value="crossfeed">Crossfeed</option>
          </select>
        </div>
      </div>
      <div class="eq-sliders" id="eqSliders"></div>
      <div class="eq-reset-row">
        <button type="button" class="eq-reset-btn" id="eqResetBtn">Reset to Flat</button>
      </div>
    </div>
  </div>
</div>
<script>
(function(){
  var audio = window._rvxAudio;
  if (!audio) return;

  var audioCtx = null;
  var eqFilters = [];
  var spatialGains = {};
  var spatialDelays = {};
  var eqInited = false;

  var EQ_FREQS = [32, 64, 125, 250, 500, 1000, 2000, 4000, 8000, 16000];
  var FREQ_LABELS = ['32','64','125','250','500','1K','2K','4K','8K','16K'];
  var EQ_PRESETS = {
    flat:           [0,0,0,0,0,0,0,0,0,0],
    bass_boost:     [6,5,4,2,0,0,0,0,0,0],
    treble_boost:   [0,0,0,0,0,2,3,4,5,6],
    vocal:          [-2,-1,0,2,4,4,3,1,0,-1],
    rock:           [4,3,1,-1,-2,1,3,4,4,3],
    pop:            [-1,1,3,4,3,0,-1,-1,1,2],
    jazz:           [3,2,0,2,-2,-2,0,2,3,4],
    classical:      [4,3,2,1,0,0,0,1,2,3],
    loudness:       [6,4,0,0,-2,0,-1,-4,4,2],
    small_speakers: [5,4,3,1,0,1,2,3,3,2],
    earphones:      [-1,-1,0,1,2,2,1,0,-1,-2],
    headphones:     [2,1,0,0,-1,0,1,2,2,1]
  };

  var currentPreset = 'flat';
  var currentBands = [0,0,0,0,0,0,0,0,0,0];
  var currentSpatial = 'off';
  var customBands = [0,0,0,0,0,0,0,0,0,0];

  try {
    var saved = localStorage.getItem('rendezvox_listener_eq');
    if (saved) {
      var d = JSON.parse(saved);
      currentPreset = d.preset || 'flat';
      currentSpatial = d.spatial || 'off';
      customBands = d.customBands || [0,0,0,0,0,0,0,0,0,0];
      if (currentPreset === 'custom') {
        currentBands = customBands.slice();
      } else if (EQ_PRESETS[currentPreset]) {
        currentBands = EQ_PRESETS[currentPreset].slice();
      }
    }
  } catch(e) {}

  function saveEq() {
    try {
      localStorage.setItem('rendezvox_listener_eq', JSON.stringify({
        preset: currentPreset, bands: currentBands,
        spatial: currentSpatial, customBands: customBands
      }));
    } catch(e) {}
  }

  function initAudioChain() {
    if (eqInited) {
      if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
      return;
    }
    try {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      var source = audioCtx.createMediaElementSource(audio);

      var prev = source;
      EQ_FREQS.forEach(function(freq, i) {
        var f = audioCtx.createBiquadFilter();
        f.type = 'peaking';
        f.frequency.value = freq;
        f.Q.value = 1.4;
        f.gain.value = currentBands[i] || 0;
        prev.connect(f);
        eqFilters.push(f);
        prev = f;
      });

      var splitter = audioCtx.createChannelSplitter(2);
      var merger = audioCtx.createChannelMerger(2);
      spatialGains.lMain = audioCtx.createGain();
      spatialGains.rMain = audioCtx.createGain();
      spatialGains.lToR = audioCtx.createGain();
      spatialGains.rToL = audioCtx.createGain();
      spatialDelays.lToR = audioCtx.createDelay(0.1);
      spatialDelays.rToL = audioCtx.createDelay(0.1);

      prev.connect(splitter);
      splitter.connect(spatialGains.lMain, 0);
      spatialGains.lMain.connect(merger, 0, 0);
      splitter.connect(spatialGains.rToL, 1);
      spatialGains.rToL.connect(spatialDelays.rToL);
      spatialDelays.rToL.connect(merger, 0, 0);
      splitter.connect(spatialGains.rMain, 1);
      spatialGains.rMain.connect(merger, 0, 1);
      splitter.connect(spatialGains.lToR, 0);
      spatialGains.lToR.connect(spatialDelays.lToR);
      spatialDelays.lToR.connect(merger, 0, 1);
      merger.connect(audioCtx.destination);

      applySpatial();
      eqInited = true;
    } catch(e) { audioCtx = null; }
  }

  function applyBands() {
    eqFilters.forEach(function(f, i) { f.gain.value = currentBands[i] || 0; });
  }

  function applySpatial() {
    var modes = {
      off:         {l:1,r:1,lr:0,rl:0,d:0},
      stereo_wide: {l:1.15,r:1.15,lr:-0.25,rl:-0.25,d:0.012},
      surround:    {l:1.3,r:1.3,lr:-0.4,rl:-0.4,d:0.018},
      crossfeed:   {l:0.85,r:0.85,lr:0.3,rl:0.3,d:0.004}
    };
    var m = modes[currentSpatial] || modes.off;
    if (spatialGains.lMain) {
      spatialGains.lMain.gain.value = m.l;
      spatialGains.rMain.gain.value = m.r;
      spatialGains.lToR.gain.value = m.lr;
      spatialGains.rToL.gain.value = m.rl;
      spatialDelays.lToR.delayTime.value = m.d;
      spatialDelays.rToL.delayTime.value = m.d;
    }
  }

  document.getElementById('turntable').addEventListener('click', initAudioChain);
  document.getElementById('tapOverlay').addEventListener('click', initAudioChain);

  var eqModal = document.getElementById('eqModal');
  var presetSel = document.getElementById('eqPresetSel');
  var spatialSel = document.getElementById('eqSpatialSel');
  var slidersWrap = document.getElementById('eqSliders');
  var sliderInputs = [];

  function fmtVal(v) { return v > 0 ? '+' + v : '' + v; }

  function buildSliders() {
    var html = '';
    FREQ_LABELS.forEach(function(label, i) {
      html += '<div class="eq-band">'
        + '<div class="eq-band-val" id="eqVal' + i + '">' + fmtVal(currentBands[i]) + '</div>'
        + '<input type="range" min="-12" max="12" step="1" value="' + currentBands[i] + '" data-idx="' + i + '" orient="vertical">'
        + '<div class="eq-band-label">' + label + '</div></div>';
    });
    slidersWrap.innerHTML = html;
    sliderInputs = [].slice.call(slidersWrap.querySelectorAll('input[type="range"]'));
    sliderInputs.forEach(function(inp) {
      inp.addEventListener('input', function() {
        var idx = parseInt(this.dataset.idx, 10);
        currentBands[idx] = parseInt(this.value, 10);
        document.getElementById('eqVal' + idx).textContent = fmtVal(currentBands[idx]);
        currentPreset = 'custom';
        presetSel.value = 'custom';
        customBands = currentBands.slice();
        applyBands();
        saveEq();
      });
    });
  }

  function updateSliders() {
    sliderInputs.forEach(function(inp, i) {
      inp.value = currentBands[i];
      document.getElementById('eqVal' + i).textContent = fmtVal(currentBands[i]);
    });
  }

  document.getElementById('btnEq').addEventListener('click', function() {
    initAudioChain();
    if (!sliderInputs.length) buildSliders();
    updateSliders();
    presetSel.value = currentPreset;
    spatialSel.value = currentSpatial;
    if (!eqInited) {
      document.getElementById('eqUnavailable').style.display = '';
      document.getElementById('eqControls').style.display = 'none';
    } else {
      document.getElementById('eqUnavailable').style.display = 'none';
      document.getElementById('eqControls').style.display = '';
    }
    eqModal.classList.remove('hidden');
  });

  document.getElementById('eqClose').addEventListener('click', function() {
    eqModal.classList.add('hidden');
  });
  eqModal.addEventListener('click', function(e) {
    if (e.target === eqModal) eqModal.classList.add('hidden');
  });

  presetSel.addEventListener('change', function() {
    currentPreset = this.value;
    if (currentPreset === 'custom') {
      currentBands = customBands.slice();
    } else if (EQ_PRESETS[currentPreset]) {
      currentBands = EQ_PRESETS[currentPreset].slice();
    }
    updateSliders();
    applyBands();
    saveEq();
  });

  spatialSel.addEventListener('change', function() {
    currentSpatial = this.value;
    applySpatial();
    saveEq();
  });

  document.getElementById('eqResetBtn').addEventListener('click', function() {
    currentPreset = 'flat';
    currentBands = [0,0,0,0,0,0,0,0,0,0];
    currentSpatial = 'off';
    presetSel.value = 'flat';
    spatialSel.value = 'off';
    updateSliders();
    applyBands();
    applySpatial();
    saveEq();
  });
})();
</script>
</body>
</html>
