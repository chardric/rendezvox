<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Radio</title>
<meta name="description" content="Listen live, request songs, and see what's playing now.">
<meta name="theme-color" content="#141416">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Radio">
<link rel="manifest" href="/api/manifest.json">
<link rel="icon" type="image/svg+xml" href="/assets/icon.svg">
<link rel="icon" type="image/png" sizes="192x192" href="/assets/icon-192x192.png">
<link rel="apple-touch-icon" href="/assets/icon-192x192.png">
<style>
:root{--accent:#ff7800;--accent-hover:#ff8c1a}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  background:#0a0a0c;color:#e0e0e0;
  display:flex;flex-direction:column;justify-content:center;align-items:center;
  min-height:100vh;
}
.card{
  background:#141416;border-radius:16px;padding:20px 24px;
  width:100%;max-width:380px;text-align:center;
  box-shadow:0 8px 32px rgba(0,0,0,.4);
}
.station-logo{width:80px;height:80px;object-fit:contain;border-radius:12px;margin:0 auto 10px;display:block}
.station-name{font-size:1.3rem;font-weight:700;color:#fff;margin-bottom:2px}
.tagline{font-size:.8rem;color:#666;margin-bottom:14px}

/* Cover Art */
/* Vinyl record */
.vinyl-wrap{
  width:110px;height:110px;border-radius:50%;margin:0 auto 12px;
  position:relative;
  background:
    radial-gradient(circle,transparent 21%,rgba(255,255,255,.04) 21.3%,transparent 21.6%,
    transparent 30%,rgba(255,255,255,.03) 30.3%,transparent 30.6%,
    transparent 39%,rgba(255,255,255,.04) 39.3%,transparent 39.6%,
    transparent 55%,rgba(255,255,255,.03) 55.3%,transparent 55.6%,
    transparent 65%,rgba(255,255,255,.04) 65.3%,transparent 65.6%,
    transparent 75%,rgba(255,255,255,.03) 75.3%,transparent 75.6%,
    transparent 85%,rgba(255,255,255,.04) 85.3%,transparent 85.6%,
    transparent 93%,rgba(255,255,255,.03) 93.3%,transparent 93.6%),
    radial-gradient(circle,#1a1a1a 22%,#111 50%,#0d0d0d 80%,#080808);
  box-shadow:0 4px 20px rgba(0,0,0,.5),inset 0 0 3px rgba(255,255,255,.03);
}
.vinyl-wrap.spinning{animation:vinyl-spin 4s linear infinite}
@keyframes vinyl-spin{to{transform:rotate(360deg)}}
.vinyl-label{
  position:absolute;width:44%;height:44%;border-radius:50%;
  top:50%;left:50%;transform:translate(-50%,-50%);
  overflow:hidden;z-index:1;
  background:var(--accent);
  display:flex;align-items:center;justify-content:center;
}
.vinyl-label img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.vinyl-hole{
  position:absolute;width:7px;height:7px;border-radius:50%;
  background:#000;top:50%;left:50%;transform:translate(-50%,-50%);z-index:2;
  box-shadow:inset 0 0 1px rgba(255,255,255,.15);
}

/* Now Playing */
.now-playing{margin-bottom:14px}
.song-title{font-size:1.05rem;font-weight:600;color:#fff}
.song-artist{font-size:.875rem;color:#9ca3af;margin-top:3px}
.not-playing{color:#555;font-style:italic}

/* Progress */
.progress-wrap{margin-bottom:12px;padding:0 4px}
.progress-bar{
  width:100%;height:4px;background:#232326;border-radius:2px;overflow:hidden;
}
.progress-fill{
  height:100%;background:var(--accent);border-radius:2px;
  width:0%;transition:width .3s linear;
}
.progress-time{
  display:flex;justify-content:space-between;
  font-size:.7rem;color:#555;margin-top:3px;
}
.progress-wrap.hidden .progress-bar,.progress-wrap.hidden .progress-time{visibility:hidden}

/* Controls */
.controls{display:flex;align-items:center;gap:12px;justify-content:center;margin-bottom:12px}
button{
  background:none;border:none;cursor:pointer;color:#e0e0e0;
  display:flex;align-items:center;justify-content:center;
}
button:hover{color:#fff}
.btn-play{
  width:48px;height:48px;border-radius:50%;
  background:var(--accent);color:#fff;
}
.btn-play:hover{background:var(--accent-hover)}
.btn-play svg{width:24px;height:24px}
.btn-sm{width:32px;height:32px}
.btn-sm svg{width:18px;height:18px}

/* Volume */
.volume-row{display:flex;align-items:center;gap:8px;justify-content:center;margin-bottom:14px}
.volume-slider{
  -webkit-appearance:none;appearance:none;
  width:120px;height:4px;background:#232326;border-radius:2px;outline:none;
}
.volume-slider::-webkit-slider-thumb{
  -webkit-appearance:none;width:13px;height:13px;
  background:var(--accent);border-radius:50%;cursor:pointer;
}
.volume-slider::-moz-range-thumb{
  width:13px;height:13px;background:var(--accent);border:none;border-radius:50%;cursor:pointer;
}

/* Up Next */
.up-next{font-size:.78rem;color:#555;margin-bottom:8px}
.up-next span{color:#9ca3af}

/* Dedication / request info */
.dedication{
  background:rgba(0,200,160,.1);border:1px solid rgba(0,200,160,.25);
  border-radius:8px;padding:8px 12px;margin-bottom:10px;
  font-size:.8rem;color:#c4b5fd;text-align:left;
  animation:fadeIn .3s ease;
}
.dedication.hidden{display:none}
.dedication .ded-label{font-size:.68rem;color:#888;text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px}
.dedication .ded-name{font-weight:600;color:#e0e0e0}
.dedication .ded-msg{margin-top:4px;font-style:italic;color:#a5b4fc}
@keyframes fadeIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}

/* Listeners */
.listeners{font-size:.78rem;color:#555;margin-bottom:12px}
.listeners span{color:#9ca3af}

/* Request button */
.btn-request{
  background:#1e1e22;color:#9ca3af;border:1px solid #232326;
  border-radius:8px;padding:10px 20px;font-size:.9rem;
  width:100%;cursor:pointer;transition:background .2s;
}
.btn-request:hover{background:#2a2a2e;color:#fff}

/* Download links */
.downloads{display:flex;align-items:center;justify-content:center;gap:16px;margin-top:10px}
.downloads a,.downloads button{
  display:flex;align-items:center;justify-content:center;
  width:28px;height:28px;border-radius:6px;transition:opacity .2s;
  text-decoration:none;
}
.downloads a:hover,.downloads button:hover{opacity:.8}
.downloads svg{width:20px;height:20px}

/* Footer */
.app-footer{
  text-align:center;padding:14px 16px 10px;font-size:.75rem;color:#9ca3af;
  display:flex;align-items:center;justify-content:center;gap:8px;
}
.app-footer a{color:#9ca3af;text-decoration:underline}
.app-footer a:hover{color:#fff}
.info-btn{
  width:22px;height:22px;border-radius:50%;
  background:var(--accent);color:#fff;font-size:.8rem;font-weight:700;font-style:italic;
  font-family:Georgia,serif;
  display:inline-flex;align-items:center;justify-content:center;
  cursor:pointer;border:none;transition:background .2s;flex-shrink:0;
}
.info-btn:hover{background:var(--accent-hover);color:#fff}

/* About modal */
.about-desc{font-size:.85rem;color:#bbb;margin-bottom:14px;line-height:1.5;text-align:center}
.about-section{margin-bottom:12px}
.about-label{font-size:.7rem;color:#666;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;font-weight:600}
.about-section a{color:var(--accent);text-decoration:none;font-size:.85rem}
.about-section a:hover{text-decoration:underline}
.about-section div{font-size:.85rem;color:#ccc}

/* Tap overlay */
.tap-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.85);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  z-index:100;cursor:pointer;
}
.tap-overlay.hidden{display:none}
.tap-text{font-size:1.4rem;color:#fff;font-weight:600}
.tap-sub{font-size:.85rem;color:#888;margin-top:8px}

/* Request modal */
.modal-backdrop{
  position:fixed;inset:0;background:rgba(0,0,0,.7);
  display:flex;align-items:center;justify-content:center;z-index:200;
}
.modal-backdrop.hidden{display:none}
.modal{
  background:#141416;border-radius:12px;padding:24px;
  width:90%;max-width:360px;
}
.modal h3{color:#fff;margin-bottom:16px;font-size:1.1rem}
.modal label{display:block;font-size:.85rem;color:#9ca3af;margin-bottom:4px;text-align:left}
.modal input,.modal textarea{
  width:100%;padding:8px 12px;background:#0a0a0c;border:1px solid #232326;
  border-radius:6px;color:#e0e0e0;font-size:.9rem;margin-bottom:12px;
  font-family:inherit;
}
.modal textarea{resize:vertical;min-height:60px}
.modal-actions{display:flex;gap:8px;justify-content:flex-end}
.modal-actions button{
  padding:8px 16px;border-radius:6px;font-size:.9rem;
}
.btn-cancel{background:#232326;color:#9ca3af}
.btn-cancel:hover{background:#444}
.btn-submit{background:var(--accent);color:#fff}
.btn-submit:hover{background:var(--accent-hover)}
.modal .msg{font-size:.85rem;margin-bottom:8px;text-align:center}
.msg-ok{color:#4ade80}
.msg-err{color:#f87171}

/* Suggestions dropdown */
.suggestions-wrap{position:relative}
.suggestions-list{
  position:absolute;left:0;right:0;top:100%;z-index:10;
  background:#18181b;border:1px solid #232326;border-radius:6px;
  max-height:200px;overflow-y:auto;list-style:none;
  margin-top:2px;
}
.suggestions-list.hidden{display:none}
.suggestions-list li{
  padding:8px 12px;cursor:pointer;border-bottom:1px solid #1e1e22;
}
.suggestions-list li:last-child{border-bottom:none}
.suggestions-list li:hover,.suggestions-list li.active{background:#1e1e22}
.suggestions-list .sg-title{color:#fff;font-size:.9rem}
.suggestions-list .sg-artist{color:#888;font-size:.8rem}

/* Resolved confirmation */
.req-resolved{
  background:#1a3a2a;border:1px solid #4ade80;border-radius:6px;
  padding:8px 12px;margin-bottom:12px;font-size:.85rem;color:#4ade80;
  display:flex;align-items:center;gap:8px;
}
.req-resolved.hidden{display:none}
.req-resolved .check-icon{flex-shrink:0}
</style>
</head>
<body>

<!-- Tap to listen overlay -->
<div class="tap-overlay hidden" id="tapOverlay">
  <div class="tap-text">Tap to Listen</div>
  <div class="tap-sub">Browser requires interaction to play audio</div>
</div>

<!-- Request modal -->
<div class="modal-backdrop hidden" id="requestModal">
  <div class="modal" style="position:relative">
    <button type="button" id="reqClose" style="position:absolute;top:10px;right:10px;background:none;border:none;color:#f87171;font-size:1.4rem;font-weight:700;cursor:pointer;line-height:1;padding:2px 6px">&times;</button>
    <h3>Request a Song</h3>
    <div style="font-size:.8rem;color:#666;margin-bottom:12px;text-align:center">Search by title, artist, or both</div>
    <div id="reqMsg"></div>
    <div id="reqResolved" class="req-resolved hidden">
      <span class="check-icon">&#10003;</span>
      <span id="reqResolvedText"></span>
    </div>
    <div class="suggestions-wrap">
      <label for="reqTitle">Song Title</label>
      <input type="text" id="reqTitle" placeholder="Start typing a song title..." autocomplete="off">
      <ul id="reqSuggestions" class="suggestions-list hidden"></ul>
    </div>
    <label for="reqArtist">Artist</label>
    <input type="text" id="reqArtist" placeholder="Artist name" autocomplete="off">
    <label for="reqName">Your Name (optional)</label>
    <input type="text" id="reqName" placeholder="Listener name" maxlength="100">
    <label for="reqMessage">Message (optional)</label>
    <textarea id="reqMessage" placeholder="Dedication or note" maxlength="500"></textarea>
    <div class="modal-actions">
      <button type="button" class="btn-cancel" id="reqCancel">Cancel</button>
      <button type="button" class="btn-submit" id="reqSubmit">Submit</button>
    </div>
  </div>
</div>

<!-- Player card -->
<div class="card">
  <img class="station-logo" id="stationLogo" src="/api/logo" alt="RendezVox" style="display:none">
  <div class="station-name" id="stationName">RendezVox</div>
  <div class="tagline">Online Radio</div>

  <div class="vinyl-wrap" id="vinylWrap">
    <div class="vinyl-label" id="vinylLabel"></div>
    <div class="vinyl-hole"></div>
  </div>
  <div class="now-playing">
    <div class="song-title" id="songTitle">—</div>
    <div class="song-artist" id="songArtist">&nbsp;</div>
  </div>

  <div class="progress-wrap hidden" id="progressWrap">
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    <div class="progress-time">
      <span id="timeElapsed">0:00</span>
      <span id="timeRemaining">-0:00</span>
    </div>
  </div>

  <div class="controls">
    <button type="button" class="btn-play" id="btnPlay" title="Play / Stop">
      <svg id="iconPlay" viewBox="0 0 24 24" fill="currentColor"><polygon points="6,3 20,12 6,21"/></svg>
      <svg id="iconStop" viewBox="0 0 24 24" fill="currentColor" style="display:none"><rect x="5" y="4" width="14" height="16" rx="2"/></svg>
    </button>
  </div>

  <div class="volume-row">
    <button type="button" class="btn-sm" id="btnMute" title="Mute / Unmute">
      <svg id="iconVol" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polygon points="11,5 6,9 2,9 2,15 6,15 11,19" fill="currentColor"/>
        <path d="M15.54 8.46a5 5 0 010 7.07"/>
        <path d="M19.07 4.93a10 10 0 010 14.14"/>
      </svg>
      <svg id="iconMuted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none">
        <polygon points="11,5 6,9 2,9 2,15 6,15 11,19" fill="currentColor"/>
        <line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/>
      </svg>
    </button>
    <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="80">
  </div>

  <div class="up-next" id="upNext">Up Next: <span>—</span></div>
  <div class="dedication hidden" id="dedication">
    <div class="ded-label">Requested by</div>
    <div class="ded-name" id="dedName"></div>
    <div class="ded-msg" id="dedMsg"></div>
  </div>
  <div class="listeners" id="listeners">Listeners: <span>—</span></div>

  <button type="button" class="btn-request" id="btnRequest">Request a Song</button>
  <div class="downloads">
    <a href="/installers/mobile/release/RendezVox-1.0.0.apk" title="Download for Android"><svg viewBox="0 0 24 24"><path fill="#3DDC84" d="M6 18c0 .55.45 1 1 1h1v3.5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5V19h2v3.5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5V19h1c.55 0 1-.45 1-1V7H6v11zM3.5 7C2.67 7 2 7.67 2 8.5v7c0 .83.67 1.5 1.5 1.5S5 16.33 5 15.5v-7C5 7.67 4.33 7 3.5 7zm17 0c-.83 0-1.5.67-1.5 1.5v7c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5v-7c0-.83-.67-1.5-1.5-1.5zm-4.97-5.84l1.3-1.3c.2-.2.2-.51 0-.71-.2-.2-.51-.2-.71 0l-1.48 1.48A5.84 5.84 0 0012 0c-.96 0-1.86.23-2.66.63L7.85.15c-.2-.2-.51-.2-.71 0-.2.2-.2.51 0 .71l1.31 1.31A5.983 5.983 0 006 6h12c0-2.21-1.2-4.15-2.97-5.18-.15-.09-.01.18 0 .16l-.5-.82zM10 4H9V3h1v1zm5 0h-1V3h1v1z"/></svg></a>
    <a href="/installers/desktop/linux/rendezvox_1.0.0_amd64.deb" title="Download for Linux"><svg viewBox="0 0 24 24"><path fill="#333" d="M12 1C9.5 1 8 3.3 8 5.5c0 .9.2 1.7.6 2.4C6.5 9.5 5 12.5 5 15c0 2.5 1.2 4.2 3 5.2V21c0 .6.4 1 1 1h6c.6 0 1-.4 1-1v-.8c1.8-1 3-2.7 3-5.2 0-2.5-1.5-5.5-3.6-7.1.4-.7.6-1.5.6-2.4C16 3.3 14.5 1 12 1z"/><ellipse fill="#FFF" cx="12" cy="14" rx="3.2" ry="4.5"/><ellipse fill="#F0C674" cx="12" cy="6.5" rx="1.6" ry=".6"/><circle fill="#FFF" cx="10.5" cy="4.5" r=".9"/><circle fill="#FFF" cx="13.5" cy="4.5" r=".9"/><circle fill="#333" cx="10.8" cy="4.5" r=".45"/><circle fill="#333" cx="13.2" cy="4.5" r=".45"/><ellipse fill="#F0C674" cx="10" cy="22.3" rx="1.8" ry=".7"/><ellipse fill="#F0C674" cx="14" cy="22.3" rx="1.8" ry=".7"/></svg></a>
    <a href="/installers/desktop/windows/RendezVox%20Setup%201.0.0.exe" title="Download for Windows"><svg viewBox="0 0 24 24"><path fill="#00ADEF" d="M0 3.449L9.75 2.1v9.451H0m10.949-9.602L24 0v11.4H10.949M0 12.6h9.75v9.451L0 20.699M10.949 12.6H24V24l-12.9-1.801"/></svg></a>
    <a href="https://github.com/chardric/rendezvox" target="_blank" rel="noopener" title="GitHub"><svg viewBox="0 0 24 24"><path fill="#9ca3af" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844a9.59 9.59 0 012.504.337c1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"/></svg></a>
    <button type="button" class="info-btn" id="btnAbout" title="About RendezVox">i</button>
  </div>
</div>

<script>
// Redirect logged-in admins to the dashboard instead of showing the listener page
(function(){
  if (new URLSearchParams(location.search).get('preview') === '1') return;
  var token = localStorage.getItem('rendezvox_token');
  if (!token) return;
  try {
    var payload = JSON.parse(atob(token.split('.')[1].replace(/-/g,'+').replace(/_/g,'/')));
    if (payload && payload.exp && payload.exp > Math.floor(Date.now() / 1000)) {
      window.location.replace('/admin/dashboard');
    }
  } catch (e) {}
})();
</script>
<script>
(function(){
  var audio     = new Audio();
  var streamUrl = '/stream/live';
  var iceUrl    = '/stream';
  var playing   = false;
  var userVol   = 0.8;
  var reconnecting   = false;
  var reconnectTimer = null;
  var stallTimer     = null;
  var stationName    = 'Radio';

  // Show station logo + dynamic favicon
  var logoEl = document.getElementById('stationLogo');
  if (logoEl) {
    logoEl.src = '/api/logo?v=' + Date.now();
    logoEl.onload = function() {
      logoEl.style.display = '';
      var fav = document.querySelector('link[rel="icon"]');
      if (fav) fav.href = logoEl.src;
    };
  }

  // Load station branding
  var accentHex = '#ff7800';
  fetch('/api/config', {cache:'no-store'}).then(function(r){ return r.json(); }).then(function(cfg) {
    stationName = cfg.station_name || 'RendezVox';
    document.getElementById('stationName').textContent = stationName;
    document.title = stationName;
    document.querySelector('meta[name="apple-mobile-web-app-title"]').setAttribute('content', stationName);
    // Apply server accent color
    if (cfg.accent_color && /^#[0-9a-fA-F]{6}$/.test(cfg.accent_color)) {
      accentHex = cfg.accent_color;
      var root = document.documentElement;
      root.style.setProperty('--accent', accentHex);
      // Lighten by 18% for hover
      var r2 = parseInt(accentHex.slice(1,3),16), g2 = parseInt(accentHex.slice(3,5),16), b2 = parseInt(accentHex.slice(5,7),16);
      r2 = Math.min(255, Math.round(r2+(255-r2)*0.18)); g2 = Math.min(255, Math.round(g2+(255-g2)*0.18)); b2 = Math.min(255, Math.round(b2+(255-b2)*0.18));
      root.style.setProperty('--accent-hover', '#'+((1<<24)+(r2<<16)+(g2<<8)+b2).toString(16).slice(1));
    }
    rebuildArtwork();
    updateMediaSession(null, null);
  }).catch(function() {});

  var btnPlay   = document.getElementById('btnPlay');
  var iconPlay  = document.getElementById('iconPlay');
  var iconStop  = document.getElementById('iconStop');
  var btnMute   = document.getElementById('btnMute');
  var iconVol   = document.getElementById('iconVol');
  var iconMuted = document.getElementById('iconMuted');
  var slider    = document.getElementById('volumeSlider');
  var overlay   = document.getElementById('tapOverlay');
  var titleEl      = document.getElementById('songTitle');
  var artistEl     = document.getElementById('songArtist');
  var upNextEl     = document.getElementById('upNext').querySelector('span');
  var dedEl        = document.getElementById('dedication');
  var dedNameEl    = document.getElementById('dedName');
  var dedMsgEl     = document.getElementById('dedMsg');
  var listenEl     = document.getElementById('listeners').querySelector('span');
  var btnRequest   = document.getElementById('btnRequest');
  var vinylWrap    = document.getElementById('vinylWrap');
  var vinylLabel   = document.getElementById('vinylLabel');
  var progressWrap = document.getElementById('progressWrap');
  var progressFill = document.getElementById('progressFill');
  var timeElapsed  = document.getElementById('timeElapsed');
  var timeRemain   = document.getElementById('timeRemaining');
  var lastCoverId  = null;

  // Progress state (updated by API poll, ticked locally every second)
  var songStartMs  = 0;   // when the current song started (epoch ms)
  var songDurMs    = 0;   // total song duration in ms

  audio.volume = userVol;

  // ── Media Session artwork (inline SVG data URI) ──
  var artworkList = [];
  function rebuildArtwork() {
    var svg = '<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512">'
      + '<rect width="512" height="512" rx="64" fill="#141416"/>'
      + '<circle cx="256" cy="240" r="120" fill="none" stroke="' + accentHex + '" stroke-width="12"/>'
      + '<circle cx="256" cy="240" r="40" fill="' + accentHex + '"/>'
      + '<line x1="256" y1="120" x2="256" y2="100" stroke="' + accentHex + '" stroke-width="8" stroke-linecap="round"/>'
      + '<circle cx="256" cy="88" r="10" fill="' + accentHex + '"/>'
      + '<text x="256" y="420" text-anchor="middle" font-family="sans-serif" font-size="56" font-weight="700" fill="#ffffff">' + stationName + '</text>'
      + '</svg>';
    var url = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
    artworkList = [{ src: url, sizes: '512x512', type: 'image/svg+xml' }];
  }
  rebuildArtwork();

  // ── Media Session helpers ──
  function updateMediaSession(title, artist) {
    if (!('mediaSession' in navigator)) return;
    navigator.mediaSession.metadata = new MediaMetadata({
      title:  title || stationName,
      artist: artist || 'Online Radio',
      album:  stationName,
      artwork: artworkList
    });
  }

  function updateMediaSessionState(state) {
    if (!('mediaSession' in navigator)) return;
    navigator.mediaSession.playbackState = state;
  }

  function initMediaSessionHandlers() {
    if (!('mediaSession' in navigator)) return;

    navigator.mediaSession.setActionHandler('play', function() {
      if (!playing) {
        audio.src = streamUrl + '?t=' + Date.now();
        audio.muted = false;
        audio.play();
        playing = true;
        updatePlayIcon();
        updateMuteIcon();
        updateMediaSessionState('playing');
      }
    });

    navigator.mediaSession.setActionHandler('pause', function() {
      if (playing || reconnecting) {
        playing = false;
        stopReconnect();
        audio.pause();
        audio.src = '';
        updatePlayIcon();
        updateMediaSessionState('paused');
      }
    });

    navigator.mediaSession.setActionHandler('stop', function() {
      if (playing || reconnecting) {
        playing = false;
        stopReconnect();
        audio.pause();
        audio.src = '';
        updatePlayIcon();
        updateMediaSessionState('none');
      }
    });
  }

  initMediaSessionHandlers();
  updateMediaSession(null, null);

  // ── Auto-play on load ──
  function startStream() {
    audio.src = streamUrl + '?t=' + Date.now();
    audio.load();
    var p = audio.play();
    if (p && p.catch) {
      p.then(function() {
        playing = true;
        updatePlayIcon();
        updateMediaSessionState('playing');
        overlay.classList.add('hidden');
      }).catch(function() {
        // Autoplay blocked — try muted
        audio.muted = true;
        audio.play().then(function() {
          playing = true;
          updatePlayIcon();
          updateMuteIcon();
          updateMediaSessionState('playing');
          overlay.classList.remove('hidden');
        }).catch(function() {
          // Fully blocked
          overlay.classList.remove('hidden');
        });
      });
    }
  }

  startStream();

  // ── Auto-reconnect when stream drops ──
  function onStreamLost() {
    if (playing && !reconnecting) {
      startReconnect();
    }
  }

  audio.addEventListener('error', onStreamLost);
  audio.addEventListener('ended', onStreamLost);

  // Stall detection — if audio stalls for 10s with no data, treat as stream lost
  audio.addEventListener('waiting', function() {
    if (playing && !reconnecting) {
      clearTimeout(stallTimer);
      stallTimer = setTimeout(function() {
        if (playing && !reconnecting) {
          startReconnect();
        }
      }, 10000);
    }
  });

  audio.addEventListener('playing', function() {
    clearTimeout(stallTimer);
    stallTimer = null;
    if (reconnecting) {
      stopReconnect();
      playing = true;
      updatePlayIcon();
      updateMediaSessionState('playing');
    }
  });

  function startReconnect() {
    reconnecting = true;
    titleEl.textContent  = 'Reconnecting...';
    artistEl.textContent = 'Waiting for broadcast';
    progressWrap.classList.add('hidden');
    updateMediaSession('Reconnecting...', stationName);
    updateDiscSpin();
    tryReconnect();
    reconnectTimer = setInterval(tryReconnect, 5000);
  }

  function tryReconnect() {
    audio.src = streamUrl + '?t=' + Date.now();
    audio.load();
    var p = audio.play();
    if (p && p.catch) p.catch(function() {});
  }

  function stopReconnect() {
    reconnecting = false;
    clearInterval(reconnectTimer);
    reconnectTimer = null;
    clearTimeout(stallTimer);
    stallTimer = null;
    updateDiscSpin();
  }

  // ── Tap overlay ──
  overlay.addEventListener('click', function() {
    audio.muted = false;
    updateMuteIcon();
    if (!playing) {
      audio.src = streamUrl + '?t=' + Date.now();
      audio.play();
      playing = true;
    }
    overlay.classList.add('hidden');
    updatePlayIcon();
    updateMediaSessionState('playing');
  });

  // ── Play / Stop ──
  btnPlay.addEventListener('click', function() {
    if (playing || reconnecting) {
      playing = false;
      stopReconnect();
      clearTimeout(stallTimer);
      stallTimer = null;
      audio.pause();
      audio.src = '';
      updateMediaSessionState('paused');
    } else {
      audio.src = streamUrl + '?t=' + Date.now();
      audio.muted = false;
      audio.play();
      playing = true;
      updateMuteIcon();
      updateMediaSessionState('playing');
    }
    updatePlayIcon();
  });

  function updatePlayIcon() {
    iconPlay.style.display = playing ? 'none' : 'block';
    iconStop.style.display = playing ? 'block' : 'none';
    updateDiscSpin();
  }

  // ── Volume ──
  slider.addEventListener('input', function() {
    userVol = this.value / 100;
    audio.volume = userVol;
    if (userVol > 0 && audio.muted) {
      audio.muted = false;
      updateMuteIcon();
    }
  });

  // ── Mute toggle ──
  btnMute.addEventListener('click', function() {
    audio.muted = !audio.muted;
    updateMuteIcon();
  });

  function updateMuteIcon() {
    iconVol.style.display   = audio.muted ? 'none' : 'block';
    iconMuted.style.display = audio.muted ? 'block' : 'none';
  }

  // ── Request button visibility ──
  function updateRequestButton(isEmergency) {
    if (isEmergency) {
      btnRequest.textContent = 'Requests Unavailable';
      btnRequest.disabled = true;
      btnRequest.style.opacity = '0.4';
      btnRequest.style.cursor = 'default';
    } else {
      btnRequest.textContent = 'Request a Song';
      btnRequest.disabled = false;
      btnRequest.style.opacity = '';
      btnRequest.style.cursor = '';
    }
  }

  // ── Dedication / request display ──
  function updateDedication(req) {
    if (req && (req.listener_name || req.message)) {
      dedNameEl.textContent = req.listener_name || 'A listener';
      if (req.message) {
        dedMsgEl.textContent = '"' + req.message + '"';
        dedMsgEl.style.display = '';
      } else {
        dedMsgEl.style.display = 'none';
      }
      dedEl.classList.remove('hidden');
    } else {
      dedEl.classList.add('hidden');
    }
  }

  // ── Cover art (vinyl record style) ──
  function updateDiscSpin() {
    vinylWrap.classList.toggle('spinning', playing && !reconnecting);
  }

  function updateCoverArt(song) {
    var songId = (song && song.has_cover_art) ? song.id : null;
    if (songId === lastCoverId) return;
    lastCoverId = songId;
    if (!songId) {
      vinylLabel.innerHTML = '';
      // Reset media session artwork to station logo
      artworkList = [];
      rebuildArtwork();
      return;
    }
    var coverUrl = '/api/cover?id=' + songId;
    var img = new Image();
    img.onload = function() {
      vinylLabel.innerHTML = '';
      vinylLabel.appendChild(img);
      // Update media session artwork with actual cover
      if ('mediaSession' in navigator && navigator.mediaSession.metadata) {
        navigator.mediaSession.metadata.artwork = [{ src: coverUrl, sizes: '512x512', type: 'image/jpeg' }];
      }
    };
    img.onerror = function() {
      vinylLabel.innerHTML = '';
    };
    img.src = coverUrl;
    img.alt = 'Cover art';
  }

  // ── Now playing poll ──
  function fetchNowPlaying() {
    fetch('/api/now-playing').then(function(r){ return r.json(); }).then(function(data) {
      // Don't overwrite title/artist during reconnection
      if (!reconnecting) {
        if (data.song) {
          titleEl.textContent  = data.song.title;
          artistEl.textContent = data.song.artist;
          document.title = data.song.title + ' — ' + data.song.artist + ' | ' + stationName;
          updateMediaSession(data.song.title, data.song.artist);
          updateCoverArt(data.song);
          songStartMs = data.started_at ? new Date(data.started_at).getTime() : 0;
          songDurMs   = data.song.duration_ms || 0;
          progressWrap.classList.remove('hidden');
          tickProgress();
        } else {
          titleEl.textContent  = '—';
          artistEl.innerHTML   = '&nbsp;';
          document.title = stationName;
          updateMediaSession(null, null);
          updateCoverArt(null);
          songStartMs = 0;
          songDurMs   = 0;
          progressWrap.classList.add('hidden');
        }
      }
      if (data.next_track) {
        upNextEl.textContent = data.next_track.title + ' — ' + data.next_track.artist;
      } else {
        upNextEl.textContent = '—';
      }
      updateDedication(data.request);
      updateRequestButton(data.is_emergency);
    }).catch(function(){});
  }

  // ── Progress bar tick (runs every second) ──
  function tickProgress() {
    if (!songStartMs || !songDurMs) {
      progressFill.style.width = '0%';
      timeElapsed.textContent  = '0:00';
      timeRemain.textContent   = '-0:00';
      return;
    }
    var elapsed = Date.now() - songStartMs;
    if (elapsed < 0) elapsed = 0;
    if (elapsed > songDurMs) elapsed = songDurMs;
    var remaining = songDurMs - elapsed;
    var pct = (elapsed / songDurMs) * 100;

    progressFill.style.width = pct.toFixed(1) + '%';
    timeElapsed.textContent  = fmtMs(elapsed);
    timeRemain.textContent   = '-' + fmtMs(remaining);
  }

  function fmtMs(ms) {
    var totalSec = Math.floor(ms / 1000);
    var m = Math.floor(totalSec / 60);
    var s = totalSec % 60;
    return m + ':' + (s < 10 ? '0' : '') + s;
  }

  fetchNowPlaying();
  var nowPlayingPoll = setInterval(fetchNowPlaying, 30000); // slower fallback poll
  setInterval(tickProgress, 1000);

  // ── SSE real-time connection ──
  (function connectSSE() {
    if (typeof EventSource === 'undefined') return;

    var sse = new EventSource('/api/sse/now-playing');

    sse.addEventListener('now-playing', function(e) {
      try {
        var data = JSON.parse(e.data);
        if (data.song && !reconnecting) {
          titleEl.textContent  = data.song.title;
          artistEl.textContent = data.song.artist;
          document.title = data.song.title + ' — ' + data.song.artist + ' | ' + stationName;
          updateMediaSession(data.song.title, data.song.artist);
          updateCoverArt(data.song);
          songStartMs = data.song.started_at ? new Date(data.song.started_at).getTime() : 0;
          songDurMs   = data.song.duration_ms || 0;
          progressWrap.classList.remove('hidden');
          tickProgress();
        }
        if (data.next_track) {
          upNextEl.textContent = data.next_track.title + ' — ' + data.next_track.artist;
        } else {
          upNextEl.textContent = '—';
        }
        updateDedication(data.request);
        if (typeof data.is_emergency !== 'undefined') {
          updateRequestButton(data.is_emergency);
        }
      } catch (err) {}
    });

    sse.onerror = function() {
      // EventSource auto-reconnects; polling fallback still active
    };
  })();

  // ── Listener count poll ──
  function fetchListeners() {
    fetch(iceUrl + '/status-json.xsl').then(function(r){ return r.json(); }).then(function(data) {
      var src = data.icestats && data.icestats.source;
      if (!src) { listenEl.textContent = '0'; return; }
      // source can be object or array
      var sources = Array.isArray(src) ? src : [src];
      var mount = sources.find(function(s){ return s.listenurl && s.listenurl.indexOf('/live') !== -1; });
      listenEl.textContent = mount ? mount.listeners : '0';
    }).catch(function(){ listenEl.textContent = '—'; });
  }

  fetchListeners();
  setInterval(fetchListeners, 15000);

  // ── Request modal ──
  var modal        = document.getElementById('requestModal');
  var reqMsg       = document.getElementById('reqMsg');
  var reqTitle     = document.getElementById('reqTitle');
  var reqArtist    = document.getElementById('reqArtist');
  var reqName      = document.getElementById('reqName');
  var reqMsgEl     = document.getElementById('reqMessage');
  var suggestions  = document.getElementById('reqSuggestions');
  var resolvedEl   = document.getElementById('reqResolved');
  var resolvedText = document.getElementById('reqResolvedText');
  var resolvedSong = null;
  var searchTimer  = null;
  var sgIdx        = -1;

  function resetReqForm() {
    reqMsg.innerHTML = '';
    reqTitle.value = '';
    reqArtist.value = '';
    reqName.value = '';
    reqMsgEl.value = '';
    resolvedSong = null;
    resolvedEl.classList.add('hidden');
    suggestions.classList.add('hidden');
    suggestions.innerHTML = '';
    sgIdx = -1;
  }

  document.getElementById('btnRequest').addEventListener('click', function() {
    resetReqForm();
    modal.classList.remove('hidden');
    reqTitle.focus();
  });

  document.getElementById('reqCancel').addEventListener('click', function() {
    modal.classList.add('hidden');
  });
  document.getElementById('reqClose').addEventListener('click', function() {
    modal.classList.add('hidden');
  });

  modal.addEventListener('click', function(e) {
    if (e.target === modal) modal.classList.add('hidden');
  });

  // ── Autocomplete search ──
  function doSearch() {
    var title = reqTitle.value.trim();
    var artist = reqArtist.value.trim();

    if (title.length < 2 && artist.length < 2) {
      suggestions.classList.add('hidden');
      resolvedSong = null;
      resolvedEl.classList.add('hidden');
      return;
    }

    var url = '/api/search-song?';
    var params = [];
    if (title)  params.push('title=' + encodeURIComponent(title));
    if (artist) params.push('artist=' + encodeURIComponent(artist));
    url += params.join('&');

    fetch(url).then(function(r){ return r.json(); }).then(function(data) {
      if (!data.songs || data.songs.length === 0) {
        suggestions.classList.add('hidden');
        resolvedSong = null;
        resolvedEl.classList.add('hidden');
        return;
      }

      if (data.resolved) {
        selectSong(data.songs[0]);
        suggestions.classList.add('hidden');
        return;
      }

      renderSuggestions(data.songs);
    }).catch(function(){});
  }

  function renderSuggestions(songs) {
    var html = '';
    songs.forEach(function(s, i) {
      html += '<li data-idx="' + i + '">'
        + '<div class="sg-title">' + escHtml(s.title) + '</div>'
        + '<div class="sg-artist">' + escHtml(s.artist) + '</div>'
        + '</li>';
    });
    suggestions.innerHTML = html;
    suggestions._songs = songs;
    suggestions.classList.remove('hidden');
    sgIdx = -1;

    var items = suggestions.querySelectorAll('li');
    items.forEach(function(li) {
      li.addEventListener('click', function() {
        var idx = parseInt(this.getAttribute('data-idx'), 10);
        selectSong(suggestions._songs[idx]);
        suggestions.classList.add('hidden');
      });
    });
  }

  function selectSong(song) {
    resolvedSong = song;
    reqTitle.value = song.title;
    reqArtist.value = song.artist;
    resolvedText.textContent = song.title + ' — ' + song.artist;
    resolvedEl.classList.remove('hidden');
    suggestions.classList.add('hidden');
  }

  function escHtml(str) {
    if (!str) return '';
    var d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }

  // Debounced search on title input
  reqTitle.addEventListener('input', function() {
    resolvedSong = null;
    resolvedEl.classList.add('hidden');
    clearTimeout(searchTimer);
    searchTimer = setTimeout(doSearch, 350);
  });

  // Re-search when artist changes
  reqArtist.addEventListener('input', function() {
    resolvedSong = null;
    resolvedEl.classList.add('hidden');
    clearTimeout(searchTimer);
    searchTimer = setTimeout(doSearch, 350);
  });

  // Keyboard navigation for suggestions + prevent accidental submit
  function handleSuggestionKeys(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      var items = suggestions.querySelectorAll('li');
      if (items.length && !suggestions.classList.contains('hidden')) {
        // Select highlighted item, or first item if none highlighted
        var idx = sgIdx >= 0 ? sgIdx : 0;
        selectSong(suggestions._songs[idx]);
        suggestions.classList.add('hidden');
      }
      return;
    }

    var items = suggestions.querySelectorAll('li');
    if (!items.length || suggestions.classList.contains('hidden')) return;

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      sgIdx = Math.min(sgIdx + 1, items.length - 1);
      updateSgActive(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      sgIdx = Math.max(sgIdx - 1, 0);
      updateSgActive(items);
    } else if (e.key === 'Escape') {
      suggestions.classList.add('hidden');
      sgIdx = -1;
    }
  }
  reqTitle.addEventListener('keydown', handleSuggestionKeys);
  reqArtist.addEventListener('keydown', handleSuggestionKeys);

  function updateSgActive(items) {
    items.forEach(function(li, i) {
      li.classList.toggle('active', i === sgIdx);
    });
    if (items[sgIdx]) items[sgIdx].scrollIntoView({ block: 'nearest' });
  }

  // Close suggestions when clicking outside
  document.addEventListener('click', function(e) {
    if (!suggestions.contains(e.target) && e.target !== reqTitle && e.target !== reqArtist) {
      suggestions.classList.add('hidden');
    }
  });

  // ── Submit request ──
  document.getElementById('reqSubmit').addEventListener('click', function() {
    var title = reqTitle.value.trim();
    var artist = reqArtist.value.trim();
    if (!title && !artist) {
      reqMsg.innerHTML = '<div class="msg msg-err">Enter a song title or artist name</div>';
      return;
    }

    var body = {};
    if (title) body.title = title;
    var name = reqName.value.trim();
    var msg  = reqMsgEl.value.trim();
    if (artist) body.artist = artist;
    if (name)   body.listener_name = name;
    if (msg)    body.message = msg;

    fetch('/api/request', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    }).then(function(r){ return r.json().then(function(d){ return {ok:r.ok, status:r.status, data:d}; }); })
      .then(function(res) {
        if (res.ok) {
          var s = res.data.song;
          reqMsg.innerHTML = '<div class="msg msg-ok">Requested: ' + escHtml(s.title) + ' — ' + escHtml(s.artist) + '</div>';
          setTimeout(function(){ modal.classList.add('hidden'); }, 2000);
        } else if (res.status === 422 && res.data.suggestions) {
          reqMsg.innerHTML = '<div class="msg msg-err">Multiple matches — please select one:</div>';
          renderSuggestions(res.data.suggestions);
        } else {
          reqMsg.innerHTML = '<div class="msg msg-err">' + escHtml(res.data.error || 'Request failed') + '</div>';
        }
      }).catch(function() {
        reqMsg.innerHTML = '<div class="msg msg-err">Network error</div>';
      });
  });

  // ── Service worker registration ──
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js');
  }

})();
</script>
<script src="/assets/scroll-controls.js"></script>
<footer class="app-footer">&copy; 2026 <a href="https://downstreamtech.net" target="_blank" rel="noopener">DownStreamTech</a>. All rights reserved.</footer>

<!-- About modal -->
<div class="modal-backdrop hidden" id="aboutModal">
  <div class="modal" style="text-align:left;position:relative">
    <button type="button" id="aboutClose" style="position:absolute;top:10px;right:10px;background:none;border:none;color:#f87171;font-size:1.4rem;font-weight:700;cursor:pointer;line-height:1;padding:2px 6px">&times;</button>
    <h3 style="text-align:center">About RendezVox</h3>
    <p class="about-desc">Your personal online FM radio station — stream music, request songs, and listen live from any device, anywhere.</p>
    <div class="about-section">
      <div class="about-label">Links</div>
      <a href="https://downstreamtech.net" target="_blank" rel="noopener">downstreamtech.net</a><br>
      <a href="https://radio.chadlinuxtech.net" target="_blank" rel="noopener">radio.chadlinuxtech.net</a>
    </div>
    <div class="about-section">
      <div class="about-label">Support</div>
      <div>Phone: <a href="tel:+639177927953">+639177927953</a></div>
      <div>Email: <a href="mailto:support@downstreamtech.net">support@downstreamtech.net</a></div>
    </div>
    <div class="about-section">
      <div class="about-label">Developer</div>
      <div>Engr. Richard R. Ayuyang, PhD</div>
      <div style="color:#666">Professor II, CSU</div>
    </div>
  </div>
</div>
<script>
(function(){
  var aboutModal = document.getElementById('aboutModal');
  document.getElementById('btnAbout').addEventListener('click', function() {
    aboutModal.classList.remove('hidden');
  });
  document.getElementById('aboutClose').addEventListener('click', function() {
    aboutModal.classList.add('hidden');
  });
  aboutModal.addEventListener('click', function(e) {
    if (e.target === aboutModal) aboutModal.classList.add('hidden');
  });
})();
</script>
</body>
</html>
