# ==========================================================
# iRadio — Raspberry Pi Docker Compose Override
# ==========================================================
#
# Usage (from docker/ directory):
#   docker compose -f docker-compose.yml \
#                  -f ../deploy/rpi/docker-compose.override.yml up -d
#
# This overlay tunes the base stack for RPi 3B/3B+/4/5
# with limited RAM and ARM64 CPU.
#
# Prerequisites:
#   - Raspberry Pi OS 64-bit (Bookworm or later)
#   - Docker Engine 24+ and Docker Compose v2
#   - At least 2 GB RAM (4 GB recommended)
#   - Swap enabled (1 GB minimum, 2 GB recommended)
# ==========================================================

services:

  # ── PostgreSQL — reduced shared memory & connections ──
  postgres:
    shm_size: 64mb
    environment:
      # Lower connection limits for constrained RAM
      POSTGRES_INITDB_ARGS: "--auth-host=md5"
    command:
      - "postgres"
      - "-c"
      - "shared_buffers=64MB"
      - "-c"
      - "work_mem=4MB"
      - "-c"
      - "maintenance_work_mem=32MB"
      - "-c"
      - "max_connections=30"
      - "-c"
      - "effective_cache_size=128MB"
    deploy:
      resources:
        limits:
          memory: 256M

  # ── PHP-FPM — fewer workers ─────────────────────────
  php:
    volumes:
      - ../deploy/rpi/fpm-pool.conf:/usr/local/etc/php-fpm.d/zzz-iradio.conf:ro
      - ../src:/var/www/html/src
      - ../public:/var/www/html/public
      - ../music:/var/lib/iradio/music
      - ../jingles:/var/lib/iradio/jingles
      - ../data/avatars:/var/lib/iradio/avatars
      - ../data/logos:/var/lib/iradio/logos
      - ../data/logs:/var/log/iradio
    deploy:
      resources:
        limits:
          memory: 256M

  # ── PHP-FPM — expose for host-networked nginx ───────
  # (port already set in base; just documenting the override is compatible)

  # ── Nginx — minimal footprint (host network mode) ──
  nginx:
    deploy:
      resources:
        limits:
          memory: 64M

  # ── Icecast — lower client limit ────────────────────
  icecast:
    environment:
      ICECAST_MAX_CLIENTS: ${ICECAST_MAX_CLIENTS:-30}
    deploy:
      resources:
        limits:
          memory: 64M

  # ── Liquidsoap — constrained memory ─────────────────
  liquidsoap:
    deploy:
      resources:
        limits:
          memory: 384M
