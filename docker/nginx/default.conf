# ==========================================================
# iRadio — Nginx Security-Hardened Configuration
# ==========================================================

# ── Hide Nginx version ──
server_tokens off;

# ── Real client IP (Cloudflare Zero Trust) ──
map $http_cf_connecting_ip $real_client_ip {
    ""      $remote_addr;
    default $http_cf_connecting_ip;
}

# ── Rate limiting zones ──
# Public API: 10 requests/second per IP (burst 20)
limit_req_zone $real_client_ip zone=api_public:10m rate=10r/s;
# Song search: 5 requests/second per IP
limit_req_zone $real_client_ip zone=api_search:10m rate=5r/s;
# Login: 5 requests/minute per IP (brute-force protection)
limit_req_zone $real_client_ip zone=api_login:10m rate=5r/m;
# Forgot password: 5 requests/minute per IP
limit_req_zone $real_client_ip zone=api_forgot_pw:10m rate=5r/m;
# File uploads: 2 requests/second per IP
limit_req_zone $real_client_ip zone=api_upload:10m rate=2r/s;
# Setup endpoint: 5 requests/minute per IP
limit_req_zone $real_client_ip zone=api_setup:1m rate=5r/m;
# General requests: 30 requests/second per IP
limit_req_zone $real_client_ip zone=general:10m rate=30r/s;

# Return 429 instead of 503 for rate-limited requests
limit_req_status 429;

server {
    listen 80;
    server_name _;
    root /var/www/html/public;
    index index.html index.php;

    # ── Request limits ──
    client_max_body_size 500M;
    client_body_timeout 30s;
    client_header_timeout 15s;
    send_timeout 30s;
    keepalive_timeout 65s;

    # Prevent clickjacking, MIME sniffing, and enforce security policies
    add_header X-Content-Type-Options  "nosniff"  always;
    add_header X-Frame-Options         "DENY"     always;
    add_header X-XSS-Protection        "0"        always;
    add_header Referrer-Policy         "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy      "camera=(), microphone=(), geolocation=(), payment=()" always;
    add_header X-Permitted-Cross-Domain-Policies "none" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self'; connect-src 'self'; media-src 'self' blob:; frame-ancestors 'none'; base-uri 'self'; form-action 'self'" always;

    # ── Disable directory listing ──
    autoindex off;

    # ── Clean URLs: strip .html extension ──
    # Redirect /admin/dashboard.html → /admin/dashboard (301 permanent)
    # Excludes index.html (used by nginx index directive for directory requests)
    rewrite ^(.+)(?<!index)\.html$ $1 permanent;

    # ── Service worker: never cache ──
    location = /sw.js {
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options        "DENY"    always;
    }

    # ── Login endpoint: strict rate limit (brute-force protection) ──
    location = /api/admin/login {
        limit_req zone=api_login burst=3 nodelay;

        try_files $uri /index.php$is_args$args;

        fastcgi_pass  127.0.0.1:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root/index.php;
        fastcgi_param REQUEST_URI     $request_uri;
        fastcgi_param QUERY_STRING    $query_string;
        fastcgi_param REQUEST_METHOD  $request_method;
        fastcgi_param REMOTE_ADDR             $real_client_ip;
        fastcgi_param HTTP_CF_CONNECTING_IP   $http_cf_connecting_ip;
        fastcgi_param HTTP_X_FORWARDED_FOR    $http_x_forwarded_for;
        fastcgi_param HTTP_X_REAL_IP          $http_x_real_ip;
        include       fastcgi_params;
        fastcgi_read_timeout 30s;
    }

    # ── Forgot password endpoint: strict rate limit ──
    location = /api/forgot-password {
        limit_req zone=api_forgot_pw burst=2 nodelay;

        try_files $uri /index.php$is_args$args;

        fastcgi_pass  127.0.0.1:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root/index.php;
        fastcgi_param REQUEST_URI     $request_uri;
        fastcgi_param QUERY_STRING    $query_string;
        fastcgi_param REQUEST_METHOD  $request_method;
        fastcgi_param REMOTE_ADDR             $real_client_ip;
        fastcgi_param HTTP_CF_CONNECTING_IP   $http_cf_connecting_ip;
        fastcgi_param HTTP_X_FORWARDED_FOR    $http_x_forwarded_for;
        fastcgi_param HTTP_X_REAL_IP          $http_x_real_ip;
        include       fastcgi_params;
        fastcgi_read_timeout 30s;
    }

    # ── Account activation endpoint: strict rate limit ──
    location = /api/activate-account {
        limit_req zone=api_forgot_pw burst=2 nodelay;

        try_files $uri /index.php$is_args$args;

        fastcgi_pass  127.0.0.1:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root/index.php;
        fastcgi_param REQUEST_URI     $request_uri;
        fastcgi_param QUERY_STRING    $query_string;
        fastcgi_param REQUEST_METHOD  $request_method;
        fastcgi_param REMOTE_ADDR             $real_client_ip;
        fastcgi_param HTTP_CF_CONNECTING_IP   $http_cf_connecting_ip;
        fastcgi_param HTTP_X_FORWARDED_FOR    $http_x_forwarded_for;
        fastcgi_param HTTP_X_REAL_IP          $http_x_real_ip;
        include       fastcgi_params;
        fastcgi_read_timeout 30s;
    }

    # ── Setup endpoint: strict rate limit ──
    location = /api/setup {
        limit_req zone=api_setup burst=2 nodelay;

        try_files $uri /index.php$is_args$args;

        fastcgi_pass  127.0.0.1:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root/index.php;
        fastcgi_param REQUEST_URI     $request_uri;
        fastcgi_param QUERY_STRING    $query_string;
        fastcgi_param REQUEST_METHOD  $request_method;
        fastcgi_param REMOTE_ADDR             $real_client_ip;
        fastcgi_param HTTP_CF_CONNECTING_IP   $http_cf_connecting_ip;
        fastcgi_param HTTP_X_FORWARDED_FOR    $http_x_forwarded_for;
        fastcgi_param HTTP_X_REAL_IP          $http_x_real_ip;
        include       fastcgi_params;
        fastcgi_read_timeout 30s;
    }

    # ── Song search: rate limited ──
    location = /api/search-song {
        limit_req zone=api_search burst=10 nodelay;

        try_files $uri /index.php$is_args$args;

        fastcgi_pass  127.0.0.1:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root/index.php;
        fastcgi_param REQUEST_URI     $request_uri;
        fastcgi_param QUERY_STRING    $query_string;
        fastcgi_param REQUEST_METHOD  $request_method;
        fastcgi_param REMOTE_ADDR             $real_client_ip;
        fastcgi_param HTTP_CF_CONNECTING_IP   $http_cf_connecting_ip;
        fastcgi_param HTTP_X_FORWARDED_FOR    $http_x_forwarded_for;
        fastcgi_param HTTP_X_REAL_IP          $http_x_real_ip;
        include       fastcgi_params;
        fastcgi_read_timeout 30s;
    }

    # ── SSE endpoint: disable buffering for real-time streaming ──
    location = /api/sse/now-playing {
        try_files $uri /index.php$is_args$args;

        proxy_buffering off;
        fastcgi_buffering off;
        fastcgi_keep_conn on;
        fastcgi_read_timeout 70s;

        fastcgi_pass  127.0.0.1:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root/index.php;
        fastcgi_param REQUEST_URI     $request_uri;
        fastcgi_param QUERY_STRING    $query_string;
        fastcgi_param REQUEST_METHOD  $request_method;
        fastcgi_param REMOTE_ADDR             $real_client_ip;
        fastcgi_param HTTP_CF_CONNECTING_IP   $http_cf_connecting_ip;
        fastcgi_param HTTP_X_FORWARDED_FOR    $http_x_forwarded_for;
        fastcgi_param HTTP_X_REAL_IP          $http_x_real_ip;
        include       fastcgi_params;
    }

    # ── Icecast stream proxy (serves stream through port 80/443) ──
    # Allows Cloudflare Zero Trust / reverse proxies to carry the audio stream
    # without requiring direct access to Icecast port 8000.
    location /stream/ {
        proxy_pass http://127.0.0.1:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $real_client_ip;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
        proxy_read_timeout 300s;
        proxy_connect_timeout 10s;
        chunked_transfer_encoding on;
    }

    # ── Admin API: no rate limit (JWT-protected) ──
    location /api/admin {
        try_files $uri /index.php$is_args$args;
    }

    # ── Public API routes → front controller (rate limited) ──
    location /api {
        limit_req zone=api_public burst=20 nodelay;
        try_files $uri /index.php$is_args$args;
    }

    # ── Static files / clean URLs, fallback to front controller ──
    # try_files order: exact file → .html version (clean URLs) → directory → PHP
    # /admin/dashboard → finds dashboard.html → serves it as text/html
    location / {
        limit_req zone=general burst=50 nodelay;
        add_header Cache-Control "no-cache" always;
        try_files $uri $uri.html $uri/ /index.php$is_args$args;
    }

    # ── Static asset caching ──
    # HTML/JS/CSS: revalidate every request (ETag/Last-Modified) so code changes are picked up immediately
    location ~* \.(css|js)$ {
        add_header Cache-Control "no-cache" always;
        add_header X-Content-Type-Options "nosniff" always;
        access_log off;
    }
    # Images, fonts, icons: cache aggressively (these rarely change)
    location ~* \.(png|jpg|jpeg|gif|ico|svg|woff2?|ttf|eot|webp|webmanifest)$ {
        expires 7d;
        add_header Cache-Control "public, immutable" always;
        add_header X-Content-Type-Options "nosniff" always;
        access_log off;
    }

    # ── PHP-FPM ──
    location ~ \.php$ {
        # Only allow index.php as entry point (block direct .php access)
        fastcgi_pass  127.0.0.1:9000;
        fastcgi_index index.php;

        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param REQUEST_URI     $request_uri;
        fastcgi_param QUERY_STRING    $query_string;
        fastcgi_param REQUEST_METHOD  $request_method;
        fastcgi_param REMOTE_ADDR             $real_client_ip;
        fastcgi_param HTTP_CF_CONNECTING_IP   $http_cf_connecting_ip;
        fastcgi_param HTTP_X_FORWARDED_FOR    $http_x_forwarded_for;
        fastcgi_param HTTP_X_REAL_IP          $http_x_real_ip;
        include       fastcgi_params;

        fastcgi_read_timeout 120s;

        # Hide PHP headers
        fastcgi_hide_header X-Powered-By;
    }

    # ── Block dotfiles (.env, .git, .htaccess, etc.) ──
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # ── Block access to sensitive file types ──
    location ~* \.(sql|log|bak|old|orig|save|swp|swo|tmp|dist|fla|psd|ini|sh|inc|conf|yml|yaml|toml|lock|md|json)$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # ── Block common attack patterns ──
    location ~* (wp-admin|wp-login|wp-content|wp-includes|xmlrpc\.php|phpmyadmin|adminer|\.asp|\.aspx|\.jsp|\.cgi) {
        deny all;
        access_log off;
        log_not_found off;
    }

    # ── Block access to source code directories ──
    location ~ ^/(src|docs|docker|deploy|mobile|liquidsoap|data|vendor|node_modules)/ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # ── Block PHP execution in upload directories ──
    location ~ ^/(music|jingles|avatars)/.*\.php$ {
        deny all;
    }
}
